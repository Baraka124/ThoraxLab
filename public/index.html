<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TH√òRAXLAB | Collaboration Dashboard</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=SF+Mono:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --thorax-primary: #1A5F7A;
            --thorax-secondary: #0D8B70;
            --thorax-accent: #6D5ACF;
            --thorax-warning: #F59E0B;
            --thorax-success: #10B981;
            --ui-dark: #1E293B;
            --ui-medium: #475569;
            --ui-light: #64748B;
            --ui-lighter: #94A3B8;
            --ui-bg: #F8FAFC;
            --ui-card: #FFFFFF;
            --ui-border: #E2E8F0;
            --font-display: 'SF Mono', monospace;
            --font-body: 'Inter', sans-serif;
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: var(--font-body);
            background: var(--ui-bg);
            color: var(--ui-dark);
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 1.5rem;
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        
        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .dashboard-header {
            background: white;
            border-bottom: 1px solid var(--ui-border);
            padding: 1rem 0;
            margin-bottom: 1.5rem;
        }
        
        .header-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .thoraxlab-brand {
            font-family: var(--font-display);
            font-weight: 600;
            font-size: 1.25rem;
            color: var(--thorax-primary);
            text-decoration: none;
        }
        
        .thoraxlab-brand .zero {
            color: var(--thorax-accent);
        }
        
        .welcome-section {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, var(--thorax-primary) 0%, #14485E 100%);
            color: white;
            border-radius: var(--radius-xl);
            padding: 2rem;
            margin-bottom: 1rem;
        }
        
        .welcome-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 2rem;
        }
        
        @media (max-width: 768px) {
            .welcome-content {
                flex-direction: column;
                gap: 1rem;
            }
        }
        
        .welcome-text h1 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .welcome-text p {
            opacity: 0.9;
            max-width: 600px;
        }
        
        .activity-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .metric-card {
            background: var(--ui-card);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            border: 1px solid var(--ui-border);
            transition: all 0.2s;
        }
        
        .metric-card:hover {
            border-color: var(--thorax-accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .metric-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }
        
        .icon-clinical { background: rgba(26, 95, 122, 0.1); color: var(--thorax-primary); }
        .icon-industry { background: rgba(107, 91, 207, 0.1); color: var(--thorax-accent); }
        .icon-collab { background: linear-gradient(135deg, rgba(26, 95, 122, 0.1), rgba(107, 91, 207, 0.1)); color: var(--thorax-accent); }
        .icon-decision { background: rgba(13, 139, 112, 0.1); color: var(--thorax-secondary); }
        
        .metric-trend {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
        }
        
        .trend-up { background: rgba(16, 185, 129, 0.1); color: var(--thorax-success); }
        .trend-down { background: rgba(239, 68, 68, 0.1); color: #EF4444; }
        
        .metric-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--ui-dark);
            margin-bottom: 0.25rem;
        }
        
        .metric-label {
            font-size: 0.875rem;
            color: var(--ui-medium);
        }
        
        .collaboration-map {
            background: var(--ui-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--ui-border);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .map-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .map-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--ui-dark);
        }
        
        .map-visualization {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 1rem;
            align-items: center;
            padding: 1rem;
            background: var(--ui-bg);
            border-radius: var(--radius-md);
        }
        
        .map-side {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .side-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
        }
        
        .side-clinical { color: var(--thorax-primary); }
        .side-industry { color: var(--thorax-accent); }
        
        .connection-count {
            font-size: 2rem;
            font-weight: 700;
            text-align: center;
            color: var(--thorax-accent);
        }
        
        .connection-label {
            text-align: center;
            font-size: 0.875rem;
            color: var(--ui-medium);
        }
        
        .active-threads {
            background: var(--ui-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--ui-border);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .threads-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .thread-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--ui-border);
            transition: background 0.2s;
            cursor: pointer;
        }
        
        .thread-item:hover {
            background: var(--ui-bg);
        }
        
        .thread-item:last-child {
            border-bottom: none;
        }
        
        .thread-info {
            flex: 1;
        }
        
        .thread-title {
            font-weight: 500;
            color: var(--ui-dark);
            margin-bottom: 0.25rem;
        }
        
        .thread-meta {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.75rem;
            color: var(--ui-light);
        }
        
        .thread-badge {
            padding: 0.125rem 0.5rem;
            border-radius: var(--radius-sm);
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .badge-clinical { background: rgba(26, 95, 122, 0.1); color: var(--thorax-primary); }
        .badge-industry { background: rgba(107, 91, 207, 0.1); color: var(--thorax-accent); }
        .badge-joint { background: linear-gradient(90deg, rgba(26, 95, 122, 0.1), rgba(107, 91, 207, 0.1)); color: var(--thorax-accent); }
        
        .pending-decisions {
            background: var(--ui-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--ui-border);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .decision-item {
            padding: 1rem;
            border-bottom: 1px solid var(--ui-border);
            cursor: pointer;
        }
        
        .decision-item:last-child {
            border-bottom: none;
        }
        
        .decision-title {
            font-weight: 500;
            color: var(--ui-dark);
            margin-bottom: 0.5rem;
        }
        
        .decision-progress {
            margin-bottom: 0.75rem;
        }
        
        .progress-bar {
            height: 4px;
            background: var(--ui-border);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--thorax-secondary);
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        .sidebar-section {
            background: var(--ui-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--ui-border);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--ui-medium);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }
        
        .action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem;
            background: var(--ui-bg);
            border: 1px solid var(--ui-border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            border: none;
            font-family: inherit;
        }
        
        .action-btn:hover {
            background: var(--ui-card);
            border-color: var(--thorax-primary);
            transform: translateY(-2px);
        }
        
        .action-icon {
            font-size: 1.25rem;
            color: var(--thorax-primary);
        }
        
        .action-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--ui-dark);
        }
        
        .activity-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--ui-bg);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
        }
        
        .activity-icon {
            width: 24px;
            height: 24px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 0.75rem;
        }
        
        .icon-discussion { background: rgba(26, 95, 122, 0.1); color: var(--thorax-primary); }
        .icon-comment { background: rgba(107, 91, 207, 0.1); color: var(--thorax-accent); }
        .icon-decision { background: rgba(13, 139, 112, 0.1); color: var(--thorax-secondary); }
        .icon-evidence { background: rgba(245, 158, 11, 0.1); color: var(--thorax-warning); }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-text {
            color: var(--ui-dark);
            margin-bottom: 0.125rem;
        }
        
        .activity-time {
            font-size: 0.75rem;
            color: var(--ui-light);
        }
        
        .team-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .team-member {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            border-radius: var(--radius-md);
            transition: background 0.2s;
        }
        
        .team-member:hover {
            background: var(--ui-bg);
        }
        
        .member-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.75rem;
            color: white;
            flex-shrink: 0;
        }
        
        .avatar-clinical { background: var(--thorax-primary); }
        .avatar-industry { background: var(--thorax-accent); }
        
        .member-info {
            flex: 1;
            min-width: 0;
        }
        
        .member-name {
            font-weight: 500;
            color: var(--ui-dark);
            font-size: 0.875rem;
            margin-bottom: 0.125rem;
        }
        
        .member-status {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            color: var(--ui-light);
        }
        
        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--thorax-success);
        }
        
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--ui-light);
        }
        
        .empty-icon {
            font-size: 2rem;
            margin-bottom: 0.75rem;
            opacity: 0.3;
        }
        
        .empty-text {
            font-size: 0.875rem;
        }
        
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .login-form {
            background: white;
            border-radius: var(--radius-lg);
            padding: 2rem;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .login-form h2 {
            margin-bottom: 1.5rem;
            color: var(--thorax-primary);
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--ui-dark);
        }
        
        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--ui-border);
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 1rem;
        }
        
        .login-btn {
            width: 100%;
            padding: 0.75rem;
            background: var(--thorax-primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1rem;
        }
        
        .login-btn:hover {
            background: #14485E;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--ui-border);
            border-top-color: var(--thorax-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Login Modal (shown first) -->
    <div id="loginModal" class="login-modal" style="display: flex;">
        <div class="login-form">
            <h2>Welcome to TH√òRAXLAB</h2>
            <p style="margin-bottom: 1.5rem; color: var(--ui-medium);">Enter your details to continue</p>
            
            <div class="form-group">
                <label for="name">Full Name</label>
                <input type="text" id="name" placeholder="Dr. Alex Chen" value="Dr. Alex Chen">
            </div>
            
            <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" placeholder="alex.chen@hospital.org" value="alex.chen@hospital.org">
            </div>
            
            <div class="form-group">
                <label for="institution">Institution</label>
                <input type="text" id="institution" placeholder="Massachusetts General Hospital" value="Massachusetts General Hospital">
            </div>
            
            <button id="loginBtn" class="login-btn">
                <span id="loginText">Enter Platform</span>
                <span id="loginSpinner" style="display: none;">‚åõ</span>
            </button>
        </div>
    </div>

    <!-- Dashboard Header -->
    <header class="dashboard-header" style="display: none;">
        <div class="header-container">
            <a href="/" class="thoraxlab-brand">
                TH<span class="zero">√ò</span>RAXLAB
            </a>
            <div id="userContext" style="display: flex; align-items: center; gap: 1rem;"></div>
        </div>
    </header>

    <!-- Main Dashboard -->
    <main class="dashboard-grid" style="display: none;">
        <!-- Welcome Section -->
        <section class="welcome-section">
            <div class="welcome-content">
                <div class="welcome-text">
                    <h1 id="welcomeTitle">Welcome to ThoraxLab</h1>
                    <p id="welcomeSubtitle">Clinical-Industry Collaboration Platform</p>
                </div>
                <div class="welcome-stats">
                    <div style="display: flex; gap: 1.5rem;">
                        <div>
                            <div style="font-size: 2rem; font-weight: 700;" id="projectCount">0</div>
                            <div style="font-size: 0.875rem; opacity: 0.8;">Active Projects</div>
                        </div>
                        <div>
                            <div style="font-size: 2rem; font-weight: 700;" id="discussionCount">0</div>
                            <div style="font-size: 0.875rem; opacity: 0.8;">Active Discussions</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Left Column: Main Content -->
        <div class="main-column">
            <!-- Activity Metrics -->
            <div class="activity-metrics">
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-icon icon-clinical">
                            <i class="fas fa-stethoscope"></i>
                        </div>
                        <div class="metric-trend trend-up">+18%</div>
                    </div>
                    <div class="metric-value" id="clinicalActivity">0</div>
                    <div class="metric-label">Clinical Insights Shared</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-icon icon-industry">
                            <i class="fas fa-cogs"></i>
                        </div>
                        <div class="metric-trend trend-up">+12%</div>
                    </div>
                    <div class="metric-value" id="industryActivity">0</div>
                    <div class="metric-label">Technical Solutions Proposed</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-icon icon-collab">
                            <i class="fas fa-handshake"></i>
                        </div>
                        <div class="metric-trend trend-up">+8%</div>
                    </div>
                    <div class="metric-value" id="crossPollination">0</div>
                    <div class="metric-label">Cross-Domain Interactions</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-icon icon-decision">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="metric-trend trend-down">-2d</div>
                    </div>
                    <div class="metric-value" id="decisionVelocity">0</div>
                    <div class="metric-label">Avg. Decision Time (days)</div>
                </div>
            </div>

            <!-- Your Active Threads -->
            <div class="active-threads">
                <div class="threads-header">
                    <h2 class="map-title">Your Active Projects</h2>
                    <a href="#" id="viewProjectsBtn" style="font-size: 0.875rem; color: var(--thorax-primary); font-weight: 500;">
                        View All ‚Üí
                    </a>
                </div>
                
                <div id="activeProjectsList">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading projects...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Sidebar -->
        <div class="sidebar-column">
            <!-- Quick Actions -->
            <div class="sidebar-section">
                <div class="section-header">
                    <h3 class="section-title">Quick Actions</h3>
                </div>
                <div class="quick-actions-grid">
                    <button class="action-btn" id="newProjectBtn">
                        <div class="action-icon">+</div>
                        <div class="action-label">New Project</div>
                    </button>
                    
                    <button class="action-btn" id="joinProjectBtn">
                        <div class="action-icon">‚Üó</div>
                        <div class="action-label">Join Project</div>
                    </button>
                    
                    <button class="action-btn" id="inviteColleagueBtn">
                        <div class="action-icon">üë•</div>
                        <div class="action-label">Invite</div>
                    </button>
                    
                    <button class="action-btn" id="startDiscussionBtn">
                        <div class="action-icon">üí¨</div>
                        <div class="action-label">Discuss</div>
                    </button>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="sidebar-section">
                <div class="section-header">
                    <h3 class="section-title">Recent Activity</h3>
                </div>
                <div class="activity-list" id="recentActivityList">
                    <div class="loading" style="padding: 1rem;">
                        <div class="spinner" style="width: 24px; height: 24px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        class ThoraxLabDashboard {
            constructor() {
                this.user = null;
                this.projects = [];
                this.ws = null;
                this.initializeApp();
            }
            
            initializeApp() {
                this.setupEventListeners();
                this.showLogin();
            }
            
            showLogin() {
                document.getElementById('loginModal').style.display = 'flex';
                document.querySelector('.dashboard-header').style.display = 'none';
                document.querySelector('.dashboard-grid').style.display = 'none';
            }
            
            showDashboard() {
                document.getElementById('loginModal').style.display = 'none';
                document.querySelector('.dashboard-header').style.display = 'block';
                document.querySelector('.dashboard-grid').style.display = 'grid';
            }
            
            setupEventListeners() {
                // Login button
                document.getElementById('loginBtn').addEventListener('click', () => this.login());
                
                // Quick actions
                document.getElementById('newProjectBtn').addEventListener('click', () => this.createNewProject());
                document.getElementById('joinProjectBtn').addEventListener('click', () => this.joinProject());
                document.getElementById('inviteColleagueBtn').addEventListener('click', () => this.inviteColleague());
                document.getElementById('startDiscussionBtn').addEventListener('click', () => this.startDiscussion());
                document.getElementById('viewProjectsBtn').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.viewAllProjects();
                });
            }
            
            async login() {
                const name = document.getElementById('name').value;
                const email = document.getElementById('email').value;
                const institution = document.getElementById('institution').value;
                
                if (!name || !email) {
                    alert('Please enter your name and email');
                    return;
                }
                
                const loginBtn = document.getElementById('loginBtn');
                const loginText = document.getElementById('loginText');
                const loginSpinner = document.getElementById('loginSpinner');
                
                loginText.textContent = 'Logging in...';
                loginSpinner.style.display = 'inline';
                loginBtn.disabled = true;
                
                try {
                    const response = await fetch('/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, email, institution })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        this.user = data.user;
                        this.showDashboard();
                        this.renderUserContext();
                        this.loadDashboardData();
                        this.setupWebSocket();
                    } else {
                        alert('Login failed: ' + data.error);
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    alert('Network error. Please try again.');
                } finally {
                    loginText.textContent = 'Enter Platform';
                    loginSpinner.style.display = 'none';
                    loginBtn.disabled = false;
                }
            }
            
            renderUserContext() {
                const container = document.getElementById('userContext');
                if (!container || !this.user) return;
                
                container.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div style="width: 32px; height: 32px; background: linear-gradient(135deg, var(--thorax-primary), var(--thorax-secondary)); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.875rem;">
                            ${this.getInitials(this.user.name)}
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 600; color: var(--ui-dark);">${this.escapeHtml(this.user.name)}</div>
                            <div style="font-size: 0.75rem; color: var(--ui-light);">${this.escapeHtml(this.user.organization)}</div>
                        </div>
                    </div>
                `;
                
                document.getElementById('welcomeTitle').textContent = `Welcome back, ${this.user.name.split(' ')[0]}`;
                document.getElementById('welcomeSubtitle').textContent = 'Here\'s what\'s happening across your clinical-industry collaborations';
            }
            
            async loadDashboardData() {
                try {
                    // Load dashboard data
                    const dashboardResponse = await fetch('/api/dashboard');
                    if (dashboardResponse.ok) {
                        const dashboardData = await dashboardResponse.json();
                        this.updateDashboardMetrics(dashboardData.dashboard);
                    }
                    
                    // Load projects
                    const projectsResponse = await fetch('/api/projects');
                    if (projectsResponse.ok) {
                        const projectsData = await projectsResponse.json();
                        this.projects = projectsData.projects || [];
                        this.renderProjects();
                    }
                    
                    // Load activity
                    const activityResponse = await fetch('/api/activity');
                    if (activityResponse.ok) {
                        const activityData = await activityResponse.json();
                        this.renderRecentActivity(activityData.activity);
                    }
                    
                } catch (error) {
                    console.error('Failed to load dashboard data:', error);
                }
            }
            
            updateDashboardMetrics(dashboard) {
                if (!dashboard || !dashboard.metrics) return;
                
                document.getElementById('clinicalActivity').textContent = dashboard.metrics.clinicalActivity || 0;
                document.getElementById('industryActivity').textContent = dashboard.metrics.industryActivity || 0;
                document.getElementById('crossPollination').textContent = dashboard.metrics.crossPollination || 0;
                document.getElementById('decisionVelocity').textContent = dashboard.metrics.decisionVelocity || '0';
                
                if (dashboard.user) {
                    document.getElementById('projectCount').textContent = dashboard.user.projectCount || 0;
                }
                
                if (dashboard.platformStats) {
                    document.getElementById('discussionCount').textContent = dashboard.platformStats.total_discussions || 0;
                }
            }
            
            renderProjects() {
                const container = document.getElementById('activeProjectsList');
                if (!container) return;
                
                if (!this.projects || this.projects.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üìÅ</div>
                            <div class="empty-text">No active projects</div>
                            <button class="action-btn" id="createFirstProjectBtn" style="margin-top: 1rem; padding: 0.5rem 1rem;">
                                Create Your First Project
                            </button>
                        </div>
                    `;
                    document.getElementById('createFirstProjectBtn').addEventListener('click', () => this.createNewProject());
                    return;
                }
                
                container.innerHTML = this.projects.slice(0, 5).map(project => `
                    <div class="thread-item" onclick="dashboard.openProject('${project.id}')">
                        <div class="thread-info">
                            <div class="thread-title">${this.escapeHtml(project.title)}</div>
                            <div class="thread-meta">
                                <span>${this.escapeHtml(project.lead.name)}</span>
                                <span>‚Ä¢</span>
                                <span>${this.formatTimeAgo(project.updated_at)}</span>
                                <span class="thread-badge badge-${project.type === 'clinical' ? 'clinical' : 'industry'}">
                                    ${project.type}
                                </span>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; color: var(--ui-light);">
                            <span>${project.team_count || 0} üë•</span>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                `).join('');
            }
            
            renderRecentActivity(activity) {
                const container = document.getElementById('recentActivityList');
                if (!container) return;
                
                if (!activity || activity.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state" style="padding: 1rem;">
                            <div class="empty-text">No recent activity</div>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = activity.slice(0, 5).map(item => `
                    <div class="activity-item">
                        <div class="activity-icon icon-${item.activity_type}">
                            <i class="fas ${this.getActivityIcon(item.activity_type)}"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-text">${this.escapeHtml(item.description)}</div>
                            <div class="activity-time">${this.formatTimeAgo(item.created_at)}</div>
                        </div>
                    </div>
                `).join('');
            }
            
            setupWebSocket() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                this.ws = new WebSocket(`${protocol}//${window.location.host}`);
                
                this.ws.onopen = () => {
                    console.log('WebSocket connected');
                    if (this.user) {
                        this.ws.send(JSON.stringify({
                            type: 'authenticate',
                            userId: this.user.id
                        }));
                    }
                };
                
                this.ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    switch(data.type) {
                        case 'platform_stats':
                            this.updatePlatformStats(data.stats);
                            break;
                        case 'project_created':
                            this.addProject(data.project);
                            break;
                    }
                };
                
                this.ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                };
                
                this.ws.onclose = () => {
                    console.log('WebSocket disconnected');
                };
            }
            
            updatePlatformStats(stats) {
                if (stats.total_discussions) {
                    document.getElementById('discussionCount').textContent = stats.total_discussions;
                }
            }
            
            addProject(project) {
                this.projects.unshift(project);
                if (this.projects.length > 5) this.projects = this.projects.slice(0, 5);
                this.renderProjects();
            }
            
            // Action methods
            async createNewProject() {
                const title = prompt('Enter project title:');
                if (!title) return;
                
                const description = prompt('Enter project description:');
                if (!description) return;
                
                const type = prompt('Enter project type (clinical/industry):', 'clinical');
                
                try {
                    const response = await fetch('/api/projects', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title, description, type })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        alert('Project created successfully!');
                        this.loadDashboardData();
                    } else {
                        alert('Failed to create project: ' + data.error);
                    }
                } catch (error) {
                    console.error('Create project error:', error);
                    alert('Network error. Please try again.');
                }
            }
            
            joinProject() {
                alert('Project discovery feature coming soon!');
            }
            
            inviteColleague() {
                const email = prompt('Enter colleague\'s email:');
                if (!email) return;
                
                alert(`Invitation would be sent to ${email}`);
            }
            
            startDiscussion() {
                if (this.projects.length === 0) {
                    alert('Please create a project first');
                    return;
                }
                
                const projectId = prompt('Enter project ID:');
                if (!projectId) return;
                
                alert(`Would navigate to project ${projectId} discussion page`);
            }
            
            viewAllProjects() {
                window.location.href = '/project.html?view=all';
            }
            
            openProject(projectId) {
                window.location.href = `/project.html?id=${projectId}`;
            }
            
            // Utility methods
            getInitials(name) {
                if (!name) return '??';
                return name.split(' ')
                    .map(n => n[0])
                    .join('')
                    .toUpperCase()
                    .substring(0, 2);
            }
            
            getActivityIcon(type) {
                const icons = {
                    'discussion_created': 'fa-comment',
                    'comment_added': 'fa-reply',
                    'project_created': 'fa-project-diagram',
                    'team_member_added': 'fa-user-plus'
                };
                return icons[type] || 'fa-bell';
            }
            
            formatTimeAgo(timestamp) {
                try {
                    const date = new Date(timestamp);
                    const now = new Date();
                    const diffMs = now - date;
                    const diffMins = Math.floor(diffMs / 60000);
                    const diffHours = Math.floor(diffMs / 3600000);
                    const diffDays = Math.floor(diffMs / 86400000);
                    
                    if (diffMins < 60) return `${diffMins}m ago`;
                    if (diffHours < 24) return `${diffHours}h ago`;
                    if (diffDays < 7) return `${diffDays}d ago`;
                    return date.toLocaleDateString();
                } catch {
                    return 'Recently';
                }
            }
            
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }
        
        // Initialize dashboard
        window.dashboard = new ThoraxLabDashboard();
    </script>
</body>
</html>
