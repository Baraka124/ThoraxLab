<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ThoraxLab | Research Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-blue: #1A5F7A;
            --clinical-green: #00C9A7;
            --research-purple: #6D5ACF;
            --warning-orange: #F59E0B;
            --text-dark: #1E293B;
            --text-medium: #475569;
            --text-light: #64748B;
            --background-gray: #F8FAFC;
            --card-white: #FFFFFF;
            --border-subtle: #E2E8F0;
            --radius-smooth: 12px;
            --radius-tight: 8px;
            --shadow-subtle: 0 2px 8px rgba(0, 0, 0, 0.06);
            --shadow-medium: 0 8px 24px rgba(0, 0, 0, 0.12);
            --transition-fast: 150ms ease;
            --transition-smooth: 250ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--background-gray); color: var(--text-dark); }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 0 1.5rem; }
        
        .header {
            background: var(--card-white);
            border-bottom: 1px solid var(--border-subtle);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-subtle);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
        }
        
        .logo-badge {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-blue), var(--research-purple));
            color: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 1.25rem;
            box-shadow: 0 2px 8px rgba(26, 95, 122, 0.2);
        }
        
        .logo-text {
            line-height: 1.2;
        }
        
        .logo-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary-blue);
            letter-spacing: -0.02em;
        }
        
        .logo-subtitle {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-light);
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }
        
        .user-menu {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--primary-blue), var(--clinical-green));
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
        }
        
        .notification-badge {
            position: relative;
            cursor: pointer;
        }
        
        .badge {
            position: absolute;
            top: -6px;
            right: -6px;
            background: #EF4444;
            color: white;
            font-size: 0.6875rem;
            font-weight: 700;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
        }
        
        .dashboard { padding: 2rem 0; }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1.5rem;
        }
        
        .welcome-message h1 {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--primary-blue), var(--research-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .welcome-message p {
            color: var(--text-light);
            max-width: 600px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.25rem;
            margin-bottom: 2.5rem;
        }
        
        .stat-card {
            background: var(--card-white);
            border-radius: var(--radius-smooth);
            padding: 1.75rem;
            border: 1px solid var(--border-subtle);
            transition: var(--transition-fast);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            border-color: var(--clinical-green);
            box-shadow: var(--shadow-medium);
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(to bottom, var(--primary-blue), var(--clinical-green));
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--primary-blue);
            line-height: 1;
            display: flex;
            align-items: baseline;
            gap: 0.25rem;
        }
        
        .stat-trend {
            font-size: 0.875rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .trend-up { color: #10B981; }
        .trend-down { color: #EF4444; }
        
        .stat-label {
            margin-top: 0.75rem;
            font-size: 0.875rem;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .stat-icon {
            width: 32px;
            height: 32px;
            background: rgba(26, 95, 122, 0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-blue);
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2.5rem;
        }
        
        .action-card {
            background: var(--card-white);
            border-radius: var(--radius-smooth);
            padding: 1.5rem;
            border: 1px solid var(--border-subtle);
            transition: var(--transition-fast);
            cursor: pointer;
            text-align: center;
        }
        
        .action-card:hover {
            transform: translateY(-2px);
            border-color: var(--clinical-green);
            box-shadow: var(--shadow-medium);
        }
        
        .action-icon {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--primary-blue), var(--clinical-green));
            color: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin: 0 auto 1rem;
        }
        
        .action-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-dark);
        }
        
        .action-description {
            font-size: 0.875rem;
            color: var(--text-light);
        }
        
        .projects-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .filters {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .search-box {
            position: relative;
            min-width: 280px;
        }
        
        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
        }
        
        .form-input {
            padding: 0.875rem 1rem 0.875rem 3rem;
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-tight);
            font-family: inherit;
            font-size: 0.875rem;
            width: 100%;
            transition: var(--transition-fast);
            background: var(--card-white);
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(26, 95, 122, 0.1);
        }
        
        .form-select {
            padding: 0.875rem 1rem;
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-tight);
            background: var(--card-white);
            font-family: inherit;
            font-size: 0.875rem;
            min-width: 160px;
            cursor: pointer;
        }
        
        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.75rem;
            margin-bottom: 3rem;
        }
        
        @media (max-width: 768px) {
            .projects-grid { grid-template-columns: 1fr; }
        }
        
        .project-card {
            background: var(--card-white);
            border-radius: var(--radius-smooth);
            padding: 1.75rem;
            border: 1px solid var(--border-subtle);
            transition: var(--transition-fast);
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .project-card:hover {
            transform: translateY(-4px);
            border-color: var(--clinical-green);
            box-shadow: var(--shadow-medium);
        }
        
        .project-badge {
            position: absolute;
            top: -8px;
            right: 1.5rem;
            background: var(--clinical-green);
            color: white;
            padding: 0.25rem 0.875rem;
            border-radius: 100px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: 0 2px 8px rgba(0, 201, 167, 0.3);
        }
        
        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .project-title {
            font-size: 1.375rem;
            font-weight: 700;
            color: var(--primary-blue);
            margin-bottom: 0.5rem;
            line-height: 1.3;
            flex: 1;
        }
        
        .project-meta {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            color: var(--text-light);
        }
        
        .project-description {
            color: var(--text-medium);
            margin: 1rem 0;
            line-height: 1.6;
            flex: 1;
        }
        
        .tags {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin: 0.75rem 0;
        }
        
        .tag {
            background: rgba(26, 95, 122, 0.1);
            color: var(--primary-blue);
            padding: 0.375rem 0.875rem;
            border-radius: 100px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
        }
        
        .tag-clinical { background: rgba(0, 201, 167, 0.1); color: var(--clinical-green); }
        .tag-research { background: rgba(109, 90, 207, 0.1); color: var(--research-purple); }
        
        .project-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin: 1rem 0;
            padding: 1rem;
            background: var(--background-gray);
            border-radius: var(--radius-tight);
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-number {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-blue);
            line-height: 1;
        }
        
        .stat-label-small {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }
        
        .project-footer {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .team-avatars {
            display: flex;
        }
        
        .team-avatar {
            width: 32px;
            height: 32px;
            background: var(--primary-blue);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: -8px;
            border: 2px solid white;
        }
        
        .team-avatar.more {
            background: var(--border-subtle);
            color: var(--text-light);
            font-size: 0.6875rem;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.875rem 1.75rem;
            border-radius: var(--radius-tight);
            font-weight: 600;
            font-size: 0.875rem;
            border: none;
            cursor: pointer;
            transition: var(--transition-fast);
            text-decoration: none;
        }
        
        .btn-primary {
            background: var(--primary-blue);
            color: white;
        }
        
        .btn-primary:hover {
            background: #15526b;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(26, 95, 122, 0.2);
        }
        
        .btn-clinical {
            background: var(--clinical-green);
            color: white;
        }
        
        .btn-outline {
            background: transparent;
            border: 1px solid var(--border-subtle);
            color: var(--text-dark);
        }
        
        .btn-outline:hover {
            background: var(--background-gray);
            border-color: var(--text-light);
        }
        
        .btn-sm {
            padding: 0.625rem 1.25rem;
            font-size: 0.8125rem;
        }
        
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4rem 2rem;
            text-align: center;
        }
        
        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border-subtle);
            border-top-color: var(--primary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1.5rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            background: var(--card-white);
            border-radius: var(--radius-smooth);
            border: 1px solid var(--border-subtle);
        }
        
        .empty-icon {
            font-size: 4rem;
            color: var(--primary-blue);
            opacity: 0.3;
            margin-bottom: 1.5rem;
        }
        
        .notification {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 1.25rem 1.75rem;
            border-radius: var(--radius-smooth);
            background: var(--card-white);
            box-shadow: var(--shadow-medium);
            border-left: 4px solid var(--primary-blue);
            z-index: 9999;
            animation: slideIn 0.3s ease-out;
            max-width: 400px;
            display: none;
        }
        
        .notification-error { border-left-color: #EF4444; background: #FEF2F2; }
        .notification-success { border-left-color: #10B981; background: #F0FDF4; }
        .notification-warning { border-left-color: #F59E0B; background: #FFFBEB; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9998;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            backdrop-filter: blur(4px);
        }
        
        .modal-content {
            background: white;
            border-radius: var(--radius-smooth);
            padding: 2.5rem;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalIn 0.3s ease-out;
        }
        
        @keyframes modalIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-close:hover {
            background: var(--background-gray);
        }
        
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.25rem;
            margin: 1.5rem 0;
        }
        
        .template-card {
            padding: 1.5rem;
            border: 2px solid var(--border-subtle);
            border-radius: var(--radius-tight);
            cursor: pointer;
            transition: var(--transition-fast);
        }
        
        .template-card:hover {
            border-color: var(--clinical-green);
            transform: translateY(-2px);
        }
        
        .template-card.selected {
            border-color: var(--primary-blue);
            background: rgba(26, 95, 122, 0.05);
        }
        
        .template-icon {
            width: 48px;
            height: 48px;
            background: rgba(26, 95, 122, 0.1);
            color: var(--primary-blue);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            margin-bottom: 1rem;
        }
        
        .hidden { display: none !important; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }
        .w-full { width: 100%; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-6 { margin-top: 1.5rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        
        /* Mobile responsive */
        @media (max-width: 640px) {
            .header-content { flex-direction: column; gap: 1rem; }
            .user-menu { width: 100%; justify-content: space-between; }
            .search-box { min-width: 100%; }
            .filters { width: 100%; }
            .form-select { flex: 1; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="index.html" class="logo">
                    <div class="logo-badge">TL</div>
                    <div class="logo-text">
                        <div class="logo-title">ThoraxLab</div>
                        <div class="logo-subtitle">Research Collaboration Platform</div>
                    </div>
                </a>
                
                <div class="user-menu">
                    <div class="search-box">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" 
                               id="globalSearch" 
                               class="form-input" 
                               placeholder="Search projects, discussions...">
                    </div>
                    
                    <div class="notification-badge" id="notificationBtn">
                        <i class="fas fa-bell" style="font-size: 1.25rem; color: var(--text-light);"></i>
                        <span class="badge hidden" id="notificationCount">0</span>
                    </div>
                    
                    <div class="user-info">
                        <div class="user-avatar" id="userAvatar">JD</div>
                        <div>
                            <div style="font-weight: 600; font-size: 0.875rem;" id="userName">Dr. John Doe</div>
                            <div style="font-size: 0.75rem; color: var(--text-light);" id="userInstitution">General Hospital</div>
                        </div>
                        <button onclick="logout()" class="btn btn-outline btn-sm">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="dashboard">
        <div class="container">
            <!-- Welcome Section -->
            <div class="welcome-message">
                <h1>Welcome back, <span id="welcomeName">Researcher</span>!</h1>
                <p>Collaborate on research projects, share insights, and accelerate discoveries with your team.</p>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid" id="statsContainer">
                <!-- Stats will load here -->
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <div class="action-card" onclick="openNewProjectModal()">
                    <div class="action-icon">
                        <i class="fas fa-plus"></i>
                    </div>
                    <div class="action-title">New Research Project</div>
                    <div class="action-description">Start a new research or clinical study project</div>
                </div>
                
                <div class="action-card" onclick="openTemplateModal()">
                    <div class="action-icon">
                        <i class="fas fa-file-medical"></i>
                    </div>
                    <div class="action-title">Use a Template</div>
                    <div class="action-description">Start with a proven research methodology</div>
                </div>
                
                <div class="action-card" onclick="window.location.href='#recent'">
                    <div class="action-icon">
                        <i class="fas fa-history"></i>
                    </div>
                    <div class="action-title">Recent Activity</div>
                    <div class="action-description">See latest discussions and updates</div>
                </div>
                
                <div class="action-card" onclick="openSearchModal()">
                    <div class="action-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <div class="action-title">Advanced Search</div>
                    <div class="action-description">Find projects, discussions, and researchers</div>
                </div>
            </div>

            <!-- Projects Section -->
            <div class="projects-header">
                <h2 style="font-size: 1.75rem; font-weight: 700;">Research Projects</h2>
                
                <div class="filters">
                    <div class="search-box">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" 
                               id="projectSearch" 
                               class="form-input" 
                               placeholder="Search projects...">
                    </div>
                    
                    <select id="statusFilter" class="form-select">
                        <option value="">All Status</option>
                        <option value="planning">Planning Phase</option>
                        <option value="active">Active Research</option>
                        <option value="completed">Completed</option>
                    </select>
                    
                    <select id="sortFilter" class="form-select">
                        <option value="updated">Recently Updated</option>
                        <option value="created">Newest First</option>
                        <option value="title">Alphabetical</option>
                        <option value="engagement">Most Active</option>
                    </select>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="loading">
                <div class="spinner"></div>
                <p style="color: var(--text-light); margin-top: 1rem;">Loading research dashboard...</p>
            </div>

            <!-- Projects Grid -->
            <div id="projectsContainer" class="projects-grid"></div>

            <!-- Empty State -->
            <div id="emptyState" class="empty-state hidden">
                <div class="empty-icon">
                    <i class="fas fa-flask"></i>
                </div>
                <h3 style="margin-bottom: 0.5rem; color: var(--text-dark);">No Research Projects Yet</h3>
                <p style="color: var(--text-light); margin-bottom: 2rem; max-width: 400px; margin-left: auto; margin-right: auto;">
                    Start your first research project to begin collaboration with your team.
                </p>
                <div class="flex gap-3 justify-center">
                    <button onclick="openNewProjectModal()" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Create Project
                    </button>
                    <button onclick="openTemplateModal()" class="btn btn-outline">
                        <i class="fas fa-file-medical"></i> Browse Templates
                    </button>
                </div>
            </div>

            <!-- Pagination -->
            <div id="pagination" class="hidden" style="display: flex; justify-content: center; gap: 0.5rem; margin-top: 3rem;">
                <button id="prevPage" class="btn btn-outline btn-sm">
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                <div id="pageInfo" style="display: flex; align-items: center; padding: 0 1rem; color: var(--text-light);">
                    Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
                </div>
                <button id="nextPage" class="btn btn-outline btn-sm">
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </main>

    <!-- New Project Modal -->
    <div id="newProjectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="font-size: 1.75rem; font-weight: 700;">Create Research Project</h2>
                <button class="modal-close" onclick="closeModal('newProjectModal')">&times;</button>
            </div>
            
            <form id="createProjectForm">
                <div style="margin-bottom: 1.75rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-dark);">
                        Project Title
                    </label>
                    <input type="text" 
                           id="projectTitle" 
                           class="form-input" 
                           required
                           placeholder="e.g., 'Impact of New Treatment on Patient Outcomes'">
                </div>
                
                <div style="margin-bottom: 1.75rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-dark);">
                        Description
                    </label>
                    <textarea id="projectDescription" 
                              class="form-input" 
                              rows="5"
                              required
                              placeholder="Describe the research question, methodology, significance, and expected outcomes..."></textarea>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.75rem;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-dark);">
                            Status
                        </label>
                        <select id="projectStatus" class="form-select w-full">
                            <option value="planning">Planning Phase</option>
                            <option value="active">Active Research</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-dark);">
                            Template (Optional)
                        </label>
                        <select id="projectTemplate" class="form-select w-full">
                            <option value="">No Template</option>
                            <option value="randomized-controlled-trial">Randomized Controlled Trial</option>
                            <option value="cohort-study">Cohort Study</option>
                            <option value="case-study">Case Study</option>
                            <option value="systematic-review">Systematic Review</option>
                        </select>
                    </div>
                </div>
                
                <div style="margin-bottom: 1.75rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-dark);">
                        Tags
                    </label>
                    <div id="tagsContainer" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.75rem; min-height: 40px;"></div>
                    <div class="flex gap-2">
                        <input type="text" 
                               id="tagInput" 
                               class="form-input flex-1" 
                               placeholder="Add tag (e.g., Clinical Trial, Research, Study)">
                        <button type="button" onclick="addTag()" class="btn btn-outline">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                    <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button type="button" class="btn btn-outline btn-sm" onclick="addCommonTag('Clinical Trial')">Clinical Trial</button>
                        <button type="button" class="btn btn-outline btn-sm" onclick="addCommonTag('Research')">Research</button>
                        <button type="button" class="btn btn-outline btn-sm" onclick="addCommonTag('Study')">Study</button>
                        <button type="button" class="btn btn-outline btn-sm" onclick="addCommonTag('Analysis')">Analysis</button>
                        <button type="button" class="btn btn-outline btn-sm" onclick="addCommonTag('Data')">Data</button>
                    </div>
                </div>
                
                <div style="margin-bottom: 2rem; padding: 1.5rem; background: var(--background-gray); border-radius: var(--radius-tight);">
                    <h4 style="margin-bottom: 1rem; font-weight: 600; color: var(--text-dark);">
                        <i class="fas fa-chart-line" style="margin-right: 0.5rem;"></i>
                        Research Data (Optional)
                    </h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; color: var(--text-light);">
                                Study Population
                            </label>
                            <input type="text" 
                                   id="studyPopulation" 
                                   class="form-input" 
                                   placeholder="e.g., Adults with condition">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; color: var(--text-light);">
                                Primary Outcome
                            </label>
                            <input type="text" 
                                   id="primaryOutcome" 
                                   class="form-input" 
                                   placeholder="e.g., Change in measurement">
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-3">
                    <button type="button" class="btn btn-outline flex-1" onclick="closeModal('newProjectModal')">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary flex-1" id="createProjectBtn">
                        <i class="fas fa-plus"></i> Create Project
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Template Selection Modal -->
    <div id="templateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="font-size: 1.75rem; font-weight: 700;">Choose Research Template</h2>
                <button class="modal-close" onclick="closeModal('templateModal')">&times;</button>
            </div>
            
            <p style="color: var(--text-light); margin-bottom: 2rem;">
                Select a research methodology template to get started quickly with pre-defined structure.
            </p>
            
            <div class="template-grid" id="templatesContainer">
                <!-- Templates will load here -->
            </div>
            
            <div class="mt-6 flex gap-3">
                <button class="btn btn-outline flex-1" onclick="closeModal('templateModal')">
                    Cancel
                </button>
                <button class="btn btn-primary flex-1" id="useTemplateBtn" onclick="useSelectedTemplate()" disabled>
                    <i class="fas fa-check"></i> Use Selected Template
                </button>
            </div>
        </div>
    </div>

    <!-- Notifications Modal -->
    <div id="notificationsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="font-size: 1.75rem; font-weight: 700;">Notifications</h2>
                <button class="modal-close" onclick="closeModal('notificationsModal')">&times;</button>
            </div>
            
            <div id="notificationsContainer" style="min-height: 300px;">
                <!-- Notifications will load here -->
            </div>
            
            <div class="mt-4">
                <button class="btn btn-outline w-full" onclick="markAllNotificationsAsRead()">
                    <i class="fas fa-check-double"></i> Mark All as Read
                </button>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notificationToast" class="notification hidden"></div>

    <script>
        // ThoraxLab Dashboard - Complete Rewrite
// Version: 1.0.0
// Date: 2024-01-20

// ==================== CONFIGURATION ====================
const CONFIG = {
    API_BASE_URL: window.location.origin,
    WEBSOCKET_URL: window.location.origin,
    LOCAL_STORAGE_KEYS: {
        USER: 'thoraxlab_user_data',
        SESSION: 'thoraxlab_auth_session',
        SETTINGS: 'thoraxlab_user_settings'
    },
    PAGINATION: {
        DEFAULT_PAGE: 1,
        PAGE_SIZE: 12,
        VISIBLE_PAGES: 5
    },
    TIMING: {
        DEBOUNCE_SEARCH: 500,
        NOTIFICATION_TIMEOUT: 5000,
        TOAST_TIMEOUT: 4000,
        SPINNER_DELAY: 300
    },
    UI: {
        MODAL_TRANSITION: 300,
        CARD_HOVER_DELAY: 100,
        TOOLTIP_DELAY: 200
    }
};

// ==================== STATE MANAGEMENT ====================
class ApplicationState {
    constructor() {
        this.user = null;
        this.projects = [];
        this.stats = null;
        this.templates = [];
        this.notifications = [];
        this.unreadCount = 0;
        this.pagination = {
            current: 1,
            total: 1,
            hasNext: false,
            hasPrev: false
        };
        this.filters = {
            search: '',
            status: 'all',
            sort: 'recent',
            tags: []
        };
        this.ui = {
            isLoading: false,
            activeModal: null,
            selectedTemplate: null,
            selectedTags: new Set()
        };
        this.socket = null;
        this.listeners = new Map();
        this.timeouts = new Map();
    }

    subscribe(event, callback) {
        if (!this.listeners.has(event)) {
            this.listeners.set(event, new Set());
        }
        this.listeners.get(event).add(callback);
        return () => this.listeners.get(event).delete(callback);
    }

    emit(event, data) {
        if (this.listeners.has(event)) {
            this.listeners.get(event).forEach(callback => callback(data));
        }
    }

    clearTimeouts() {
        for (const timeout of this.timeouts.values()) {
            clearTimeout(timeout);
        }
        this.timeouts.clear();
    }
}

const appState = new ApplicationState();

// ==================== DOM MANAGER ====================
class DOMManager {
    constructor() {
        this.cache = new Map();
        this.observer = null;
    }

    get(selector, cache = true) {
        if (cache && this.cache.has(selector)) {
            return this.cache.get(selector);
        }
        
        const element = document.querySelector(selector);
        if (element && cache) {
            this.cache.set(selector, element);
        }
        return element;
    }

    getAll(selector) {
        return document.querySelectorAll(selector);
    }

    create(tag, attributes = {}, children = []) {
        const element = document.createElement(tag);
        
        Object.entries(attributes).forEach(([key, value]) => {
            if (key === 'className') {
                element.className = value;
            } else if (key === 'dataset') {
                Object.entries(value).forEach(([dataKey, dataValue]) => {
                    element.dataset[dataKey] = dataValue;
                });
            } else if (key.startsWith('on')) {
                element.addEventListener(key.slice(2).toLowerCase(), value);
            } else {
                element.setAttribute(key, value);
            }
        });
        
        children.forEach(child => {
            if (typeof child === 'string') {
                element.appendChild(document.createTextNode(child));
            } else if (child instanceof Node) {
                element.appendChild(child);
            }
        });
        
        return element;
    }

    render(container, content) {
        if (typeof content === 'string') {
            container.innerHTML = content;
        } else if (content instanceof Node) {
            container.innerHTML = '';
            container.appendChild(content);
        }
        return container;
    }

    show(element) {
        element?.classList.remove('hidden');
    }

    hide(element) {
        element?.classList.add('hidden');
    }

    toggle(element, condition) {
        if (condition) {
            this.show(element);
        } else {
            this.hide(element);
        }
    }

    addClass(element, className) {
        element?.classList.add(className);
    }

    removeClass(element, className) {
        element?.classList.remove(className);
    }

    setText(element, text) {
        if (element) element.textContent = text;
    }

    setHTML(element, html) {
        if (element) element.innerHTML = html;
    }

    observe(selector, callback, options = {}) {
        if (!this.observer) {
            this.observer = new MutationObserver((mutations) => {
                mutations.forEach(mutation => {
                    if (mutation.type === 'childList') {
                        mutation.addedNodes.forEach(node => {
                            if (node.nodeType === 1 && node.matches(selector)) {
                                callback(node);
                            }
                        });
                    }
                });
            });
            
            this.observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        }
    }
}

const DOM = new DOMManager();

// ==================== API SERVICE ====================
class ApiService {
    constructor() {
        this.baseURL = CONFIG.API_BASE_URL;
        this.headers = {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        };
    }

    getAuthHeader() {
        const session = localStorage.getItem(CONFIG.LOCAL_STORAGE_KEYS.SESSION);
        if (session) {
            return { 'Authorization': `Bearer ${JSON.parse(session).token}` };
        }
        return {};
    }

    async request(endpoint, options = {}) {
        const url = `${this.baseURL}${endpoint}`;
        const config = {
            ...options,
            headers: {
                ...this.headers,
                ...this.getAuthHeader(),
                ...options.headers
            }
        };

        try {
            const response = await fetch(url, config);
            
            if (response.status === 401) {
                this.handleUnauthorized();
                throw new Error('Authentication required');
            }

            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(error.message || `HTTP ${response.status}`);
            }

            return await response.json();
        } catch (error) {
            console.error('API Request failed:', error);
            throw error;
        }
    }

    handleUnauthorized() {
        localStorage.removeItem(CONFIG.LOCAL_STORAGE_KEYS.USER);
        localStorage.removeItem(CONFIG.LOCAL_STORAGE_KEYS.SESSION);
        window.location.href = '/login.html';
    }

    // Auth
    async getCurrentUser() {
        return this.request('/api/auth/me');
    }

    // Projects
    async getProjects(params = {}) {
        const query = new URLSearchParams({
            page: params.page || CONFIG.PAGINATION.DEFAULT_PAGE,
            limit: params.limit || CONFIG.PAGINATION.PAGE_SIZE,
            search: params.search || '',
            status: params.status || 'all',
            sort: params.sort || 'recent',
            ...params
        });
        return this.request(`/api/projects?${query}`);
    }

    async createProject(data) {
        return this.request('/api/projects', {
            method: 'POST',
            body: JSON.stringify(data)
        });
    }

    async getProject(id) {
        return this.request(`/api/projects/${id}`);
    }

    // Stats
    async getDashboardStats() {
        return this.request('/api/dashboard/stats');
    }

    // Templates
    async getTemplates() {
        return this.request('/api/templates');
    }

    // Notifications
    async getNotifications() {
        return this.request('/api/notifications');
    }

    async markNotificationRead(id) {
        return this.request(`/api/notifications/${id}/read`, {
            method: 'PUT'
        });
    }

    async markAllNotificationsRead() {
        return this.request('/api/notifications/read-all', {
            method: 'PUT'
        });
    }
}

const API = new ApiService();

// ==================== WEBSOCKET SERVICE ====================
class WebSocketService {
    constructor() {
        this.socket = null;
        this.reconnectAttempts = 0;
        this.maxReconnectAttempts = 5;
        this.reconnectDelay = 1000;
        this.listeners = new Map();
    }

    connect() {
        if (this.socket?.readyState === WebSocket.OPEN) return;

        try {
            this.socket = new WebSocket(CONFIG.WEBSOCKET_URL);
            
            this.socket.onopen = () => {
                console.log('WebSocket connected');
                this.reconnectAttempts = 0;
                this.authenticate();
            };

            this.socket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    this.handleMessage(data);
                } catch (error) {
                    console.error('Failed to parse WebSocket message:', error);
                }
            };

            this.socket.onclose = () => {
                console.log('WebSocket disconnected');
                this.attemptReconnect();
            };

            this.socket.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        } catch (error) {
            console.error('Failed to connect WebSocket:', error);
        }
    }

    authenticate() {
        const session = localStorage.getItem(CONFIG.LOCAL_STORAGE_KEYS.SESSION);
        if (session) {
            this.send({ type: 'AUTHENTICATE', token: JSON.parse(session).token });
        }
    }

    send(data) {
        if (this.socket?.readyState === WebSocket.OPEN) {
            this.socket.send(JSON.stringify(data));
        }
    }

    handleMessage(data) {
        switch (data.type) {
            case 'NOTIFICATION':
                this.handleNotification(data.payload);
                break;
            case 'PROJECT_UPDATE':
                this.handleProjectUpdate(data.payload);
                break;
            case 'AUTH_SUCCESS':
                console.log('WebSocket authenticated');
                break;
            case 'ERROR':
                console.error('WebSocket error:', data.payload);
                break;
        }
    }

    handleNotification(notification) {
        appState.notifications.unshift(notification);
        appState.unreadCount++;
        appState.emit('notification', notification);
        
        // Show toast notification
        UI.showToast(notification.message, 'info');
    }

    handleProjectUpdate(update) {
        appState.emit('projectUpdate', update);
        
        // Update local projects if needed
        const index = appState.projects.findIndex(p => p.id === update.projectId);
        if (index !== -1) {
            appState.projects[index] = { ...appState.projects[index], ...update };
            appState.emit('projectsUpdated');
        }
    }

    on(event, callback) {
        if (!this.listeners.has(event)) {
            this.listeners.set(event, new Set());
        }
        this.listeners.get(event).add(callback);
    }

    off(event, callback) {
        if (this.listeners.has(event)) {
            this.listeners.get(event).delete(callback);
        }
    }

    attemptReconnect() {
        if (this.reconnectAttempts < this.maxReconnectAttempts) {
            this.reconnectAttempts++;
            const delay = this.reconnectDelay * Math.pow(2, this.reconnectAttempts - 1);
            
            setTimeout(() => {
                console.log(`Attempting to reconnect (${this.reconnectAttempts}/${this.maxReconnectAttempts})...`);
                this.connect();
            }, delay);
        }
    }

    disconnect() {
        if (this.socket) {
            this.socket.close();
            this.socket = null;
        }
    }
}

const WS = new WebSocketService();

// ==================== UI COMPONENTS ====================
class UI {
    static showLoading(show = true) {
        const loader = DOM.get('#loadingState');
        DOM.toggle(loader, show);
        appState.ui.isLoading = show;
    }

    static showToast(message, type = 'info') {
        const toast = DOM.create('div', {
            className: `toast toast-${type}`,
            textContent: message
        });

        document.body.appendChild(toast);

        setTimeout(() => {
            toast.classList.add('show');
        }, 10);

        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, CONFIG.TIMING.TOAST_TIMEOUT);
    }

    static showNotification(message, type = 'info') {
        const notification = DOM.get('#notificationToast');
        DOM.setText(notification, message);
        DOM.removeClass(notification, 'notification-error notification-success notification-warning');
        DOM.addClass(notification, `notification-${type}`);
        DOM.show(notification);

        appState.timeouts.set('notification', setTimeout(() => {
            DOM.hide(notification);
        }, CONFIG.TIMING.NOTIFICATION_TIMEOUT));
    }

    static openModal(modalId) {
        const modal = DOM.get(`#${modalId}`);
        if (modal) {
            DOM.show(modal);
            appState.ui.activeModal = modalId;
            document.body.style.overflow = 'hidden';
        }
    }

    static closeModal() {
        if (appState.ui.activeModal) {
            const modal = DOM.get(`#${appState.ui.activeModal}`);
            if (modal) {
                DOM.hide(modal);
                appState.ui.activeModal = null;
                document.body.style.overflow = '';
            }
        }
    }

    static updatePagination() {
        const prevBtn = DOM.get('#prevPage');
        const nextBtn = DOM.get('#nextPage');
        const pageInfo = DOM.get('#pageInfo');
        const currentPage = DOM.get('#currentPage');
        const totalPages = DOM.get('#totalPages');

        if (prevBtn) {
            prevBtn.disabled = appState.pagination.current <= 1;
        }
        if (nextBtn) {
            nextBtn.disabled = appState.pagination.current >= appState.pagination.total;
        }
        if (pageInfo) {
            DOM.toggle(pageInfo, appState.pagination.total > 1);
        }
        if (currentPage) {
            DOM.setText(currentPage, appState.pagination.current);
        }
        if (totalPages) {
            DOM.setText(totalPages, appState.pagination.total);
        }
    }

    static updateNotificationBadge() {
        const badge = DOM.get('#notificationCount');
        if (badge) {
            if (appState.unreadCount > 0) {
                DOM.setText(badge, appState.unreadCount > 99 ? '99+' : appState.unreadCount);
                DOM.show(badge);
            } else {
                DOM.hide(badge);
            }
        }
    }

    static updateUserInfo() {
        if (appState.user) {
            const userName = DOM.get('#userName');
            const userInstitution = DOM.get('#userInstitution');
            const welcomeName = DOM.get('#welcomeName');
            const userAvatar = DOM.get('#userAvatar');

            if (userName) DOM.setText(userName, appState.user.name);
            if (userInstitution) DOM.setText(userInstitution, appState.user.institution || 'Research Institution');
            if (welcomeName) DOM.setText(welcomeName, appState.user.name.split(' ')[0]);
            if (userAvatar) {
                const initials = appState.user.name
                    .split(' ')
                    .map(n => n[0])
                    .join('')
                    .toUpperCase()
                    .substring(0, 2);
                DOM.setText(userAvatar, initials);
            }
        }
    }
}

// ==================== RENDERERS ====================
class Renderer {
    static renderStats(stats) {
        const container = DOM.get('#statsContainer');
        if (!container) return;

        const statsHTML = `
            <div class="stat-card">
                <div class="stat-value">${stats.totalProjects || 0}</div>
                <div class="stat-label">
                    <div class="stat-icon"><i class="fas fa-flask"></i></div>
                    Research Projects
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${stats.activeProjects || 0}</div>
                <div class="stat-label">
                    <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
                    Active Studies
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${stats.totalUsers || 0}</div>
                <div class="stat-label">
                    <div class="stat-icon"><i class="fas fa-users"></i></div>
                    Researchers
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-value">${stats.avgConsensus || 75}%</div>
                <div class="stat-label">
                    <div class="stat-icon"><i class="fas fa-handshake"></i></div>
                    Platform Consensus
                </div>
            </div>
        `;

        DOM.setHTML(container, statsHTML);
    }

    static renderProjects(projects) {
        const container = DOM.get('#projectsContainer');
        const emptyState = DOM.get('#emptyState');
        const pagination = DOM.get('#pagination');

        if (!container) return;

        if (!projects || projects.length === 0) {
            DOM.hide(container);
            DOM.show(emptyState);
            DOM.hide(pagination);
            return;
        }

        DOM.show(container);
        DOM.hide(emptyState);
        DOM.show(pagination);

        const projectsHTML = projects.map(project => this.renderProjectCard(project)).join('');
        DOM.setHTML(container, projectsHTML);
    }

    static renderProjectCard(project) {
        const statusInfo = this.getStatusInfo(project.status);
        const tags = project.tags?.slice(0, 3) || [];
        const teamMembers = project.team?.slice(0, 3) || [];

        return `
            <div class="project-card">
                <div class="project-badge" style="background: ${statusInfo.color}">
                    ${statusInfo.label}
                </div>
                <div class="project-header">
                    <h3 class="project-title">${this.escapeHTML(project.title)}</h3>
                </div>
                <div class="project-meta">
                    <span><i class="fas fa-user-md"></i> ${this.escapeHTML(project.lead)}</span>
                    <span><i class="fas fa-calendar"></i> ${this.formatDate(project.createdAt)}</span>
                </div>
                <p class="project-description">
                    ${this.escapeHTML(project.description?.substring(0, 180) || '')}
                    ${project.description?.length > 180 ? '...' : ''}
                </p>
                ${tags.length > 0 ? `
                    <div class="tags">
                        ${tags.map(tag => `<span class="tag">${this.escapeHTML(tag)}</span>`).join('')}
                        ${project.tags?.length > 3 ? `<span class="tag">+${project.tags.length - 3} more</span>` : ''}
                    </div>
                ` : ''}
                <div class="project-stats">
                    <div class="stat">
                        <div class="stat-number">${project.discussionCount || 0}</div>
                        <div class="stat-label-small">Discussions</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number">${project.commentCount || 0}</div>
                        <div class="stat-label-small">Comments</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number">${project.consensusScore || 75}%</div>
                        <div class="stat-label-small">Consensus</div>
                    </div>
                </div>
                <div class="project-footer">
                    <div class="team-avatars">
                        ${teamMembers.map((member, index) => `
                            <div class="team-avatar" title="${this.escapeHTML(member.name)}">
                                ${member.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2)}
                            </div>
                        `).join('')}
                        ${project.team?.length > 3 ? `
                            <div class="team-avatar more" title="${project.team.length - 3} more members">
                                +${project.team.length - 3}
                            </div>
                        ` : ''}
                    </div>
                    <button class="btn btn-primary" data-project-id="${project.id}">
                        <i class="fas fa-arrow-right"></i> Open Project
                    </button>
                </div>
            </div>
        `;
    }

    static renderNotifications(notifications) {
        const container = DOM.get('#notificationsContainer');
        if (!container) return;

        if (!notifications || notifications.length === 0) {
            DOM.setHTML(container, `
                <div class="empty-notifications">
                    <i class="fas fa-bell-slash"></i>
                    <h3>No Notifications</h3>
                    <p>You're all caught up!</p>
                </div>
            `);
            return;
        }

        const notificationsHTML = notifications.map(notification => `
            <div class="notification-item ${notification.read ? 'read' : 'unread'}">
                <div class="notification-header">
                    <span class="notification-type">
                        <i class="fas fa-${this.getNotificationIcon(notification.type)}"></i>
                        ${this.getNotificationTitle(notification.type)}
                    </span>
                    <span class="notification-time">${this.formatTimeAgo(notification.createdAt)}</span>
                </div>
                <div class="notification-body">
                    ${this.escapeHTML(notification.message)}
                </div>
                ${!notification.read ? `
                    <button class="btn btn-sm btn-outline mark-read-btn" data-notification-id="${notification.id}">
                        Mark as Read
                    </button>
                ` : ''}
            </div>
        `).join('');

        DOM.setHTML(container, notificationsHTML);
    }

    static renderTemplates(templates) {
        const container = DOM.get('#templatesContainer');
        if (!container) return;

        const templatesHTML = templates.map(template => `
            <div class="template-card" data-template-id="${template.id}">
                <div class="template-icon">
                    <i class="fas fa-${template.icon || 'file-alt'}"></i>
                </div>
                <h4>${this.escapeHTML(template.name)}</h4>
                <p>${this.escapeHTML(template.description)}</p>
                <div class="template-tags">
                    ${(template.tags || []).map(tag => `<span class="template-tag">${this.escapeHTML(tag)}</span>`).join('')}
                </div>
            </div>
        `).join('');

        DOM.setHTML(container, templatesHTML);
    }

    static getStatusInfo(status) {
        const statuses = {
            'planning': { label: 'Planning', color: '#F59E0B' },
            'active': { label: 'Active', color: '#00C9A7' },
            'completed': { label: 'Completed', color: '#1A5F7A' },
            'on-hold': { label: 'On Hold', color: '#64748B' }
        };
        return statuses[status] || { label: 'Project', color: '#6D5ACF' };
    }

    static getNotificationIcon(type) {
        const icons = {
            'mention': 'at',
            'comment': 'comment',
            'project_update': 'edit',
            'new_project': 'plus',
            'new_discussion': 'comments'
        };
        return icons[type] || 'bell';
    }

    static getNotificationTitle(type) {
        const titles = {
            'mention': 'Mention',
            'comment': 'Comment',
            'project_update': 'Project Updated',
            'new_project': 'New Project',
            'new_discussion': 'New Discussion'
        };
        return titles[type] || 'Notification';
    }

    static escapeHTML(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    static formatDate(dateString) {
        try {
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        } catch {
            return 'Recent';
        }
    }

    static formatTimeAgo(dateString) {
        try {
            const now = new Date();
            const date = new Date(dateString);
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return this.formatDate(dateString);
        } catch {
            return 'Recently';
        }
    }
}

// ==================== EVENT HANDLERS ====================
class EventManager {
    static init() {
        this.setupGlobalEvents();
        this.setupFormEvents();
        this.setupSearchEvents();
        this.setupFilterEvents();
        this.setupModalEvents();
        this.setupKeyboardShortcuts();
    }

    static setupGlobalEvents() {
        // Click delegation
        document.addEventListener('click', (e) => {
            // Project card buttons
            const projectBtn = e.target.closest('[data-project-id]');
            if (projectBtn) {
                e.preventDefault();
                const projectId = projectBtn.dataset.projectId;
                window.location.href = `project.html?id=${projectId}`;
                return;
            }

            // Notification badge
            if (e.target.closest('#notificationBtn')) {
                e.preventDefault();
                EventManager.handleNotificationsClick();
                return;
            }

            // Modal close buttons
            const closeBtn = e.target.closest('.modal-close, [data-close-modal]');
            if (closeBtn) {
                e.preventDefault();
                UI.closeModal();
                return;
            }

            // Modal backdrop click
            if (e.target.classList.contains('modal')) {
                UI.closeModal();
                return;
            }

            // Template selection
            const templateCard = e.target.closest('.template-card');
            if (templateCard) {
                EventManager.handleTemplateSelect(templateCard);
                return;
            }

            // Tag removal
            const tagElement = e.target.closest('#tagsContainer .tag');
            if (tagElement && e.target === tagElement) {
                tagElement.remove();
                return;
            }

            // Notification mark as read
            const markReadBtn = e.target.closest('.mark-read-btn');
            if (markReadBtn) {
                const notificationId = markReadBtn.dataset.notificationId;
                EventManager.handleMarkNotificationRead(notificationId);
                return;
            }
        });

        // State change listeners
        appState.subscribe('projectsUpdated', () => {
            Renderer.renderProjects(appState.projects);
            UI.updatePagination();
        });

        appState.subscribe('notification', (notification) => {
            UI.updateNotificationBadge();
        });
    }

    static setupFormEvents() {
        const createForm = DOM.get('#createProjectForm');
        if (createForm) {
            createForm.addEventListener('submit', EventManager.handleCreateProject);
        }

        const tagInput = DOM.get('#tagInput');
        if (tagInput) {
            tagInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ',') {
                    e.preventDefault();
                    EventManager.handleAddTag();
                }
            });
        }
    }

    static setupSearchEvents() {
        const projectSearch = DOM.get('#projectSearch');
        if (projectSearch) {
            projectSearch.addEventListener('input', EventManager.debounce((e) => {
                appState.filters.search = e.target.value;
                appState.currentPage = 1;
                Dashboard.loadProjects();
            }, CONFIG.TIMING.DEBOUNCE_SEARCH));
        }

        const globalSearch = DOM.get('#globalSearch');
        if (globalSearch) {
            globalSearch.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const searchValue = globalSearch.value.trim();
                    if (searchValue && projectSearch) {
                        projectSearch.value = searchValue;
                        appState.filters.search = searchValue;
                        appState.currentPage = 1;
                        Dashboard.loadProjects();
                    }
                    globalSearch.value = '';
                    globalSearch.blur();
                }
            });
        }
    }

    static setupFilterEvents() {
        const statusFilter = DOM.get('#statusFilter');
        if (statusFilter) {
            statusFilter.addEventListener('change', (e) => {
                appState.filters.status = e.target.value;
                appState.currentPage = 1;
                Dashboard.loadProjects();
            });
        }

        const sortFilter = DOM.get('#sortFilter');
        if (sortFilter) {
            sortFilter.addEventListener('change', (e) => {
                appState.filters.sort = e.target.value;
                appState.currentPage = 1;
                Dashboard.loadProjects();
            });
        }
    }

    static setupModalEvents() {
        // New project modal
        const newProjectBtn = DOM.get('[data-action="new-project"]');
        if (newProjectBtn) {
            newProjectBtn.addEventListener('click', () => {
                UI.openModal('newProjectModal');
            });
        }

        // Template modal
        const templateBtn = DOM.get('[data-action="open-templates"]');
        if (templateBtn) {
            templateBtn.addEventListener('click', async () => {
                await Dashboard.loadTemplates();
                UI.openModal('templateModal');
            });
        }
    }

    static setupKeyboardShortcuts() {
        document.addEventListener('keydown', (e) => {
            // Skip if user is typing in inputs
            const activeElement = document.activeElement;
            const isInput = activeElement.tagName === 'INPUT' || 
                           activeElement.tagName === 'TEXTAREA' ||
                           activeElement.isContentEditable;
            
            if (isInput && !e.ctrlKey && !e.metaKey) return;

            // Ctrl/Cmd + N for new project
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                UI.openModal('newProjectModal');
            }

            // Ctrl/Cmd + K for search
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                const search = DOM.get('#globalSearch') || DOM.get('#projectSearch');
                search?.focus();
                search?.select();
            }

            // Escape to close modals
            if (e.key === 'Escape') {
                UI.closeModal();
            }

            // Forward slash for search
            if (e.key === '/' && !isInput) {
                e.preventDefault();
                const search = DOM.get('#projectSearch');
                search?.focus();
                search?.select();
            }
        });
    }

    static handleCreateProject = async (e) => {
        e.preventDefault();
        
        const form = e.target;
        const formData = new FormData(form);
        const projectData = {
            title: formData.get('projectTitle'),
            description: formData.get('projectDescription'),
            status: formData.get('projectStatus'),
            tags: Array.from(appState.ui.selectedTags),
            template: appState.ui.selectedTemplate
        };

        try {
            UI.showLoading(true);
            const response = await API.createProject(projectData);
            
            if (response.success) {
                UI.showNotification('Project created successfully!', 'success');
                UI.closeModal();
                form.reset();
                appState.ui.selectedTags.clear();
                appState.ui.selectedTemplate = null;
                
                // Reload projects
                await Dashboard.loadProjects();
                
                // Navigate to new project after delay
                setTimeout(() => {
                    window.location.href = `project.html?id=${response.projectId}`;
                }, 1500);
            }
        } catch (error) {
            UI.showNotification(`Failed to create project: ${error.message}`, 'error');
        } finally {
            UI.showLoading(false);
        }
    };

    static handleAddTag() {
        const tagInput = DOM.get('#tagInput');
        if (!tagInput) return;

        const tag = tagInput.value.trim();
        if (tag && !appState.ui.selectedTags.has(tag)) {
            appState.ui.selectedTags.add(tag);
            this.renderTags();
            tagInput.value = '';
            tagInput.focus();
        }
    }

    static handleRemoveTag(tag) {
        appState.ui.selectedTags.delete(tag);
        this.renderTags();
    }

    static renderTags() {
        const container = DOM.get('#tagsContainer');
        if (!container) return;

        const tagsHTML = Array.from(appState.ui.selectedTags).map(tag => `
            <span class="tag" onclick="EventManager.handleRemoveTag('${tag}')">
                ${Renderer.escapeHTML(tag)}
                <i class="fas fa-times"></i>
            </span>
        `).join('');

        DOM.setHTML(container, tagsHTML);
    }

    static handleTemplateSelect(templateCard) {
        const templateId = templateCard.dataset.templateId;
        if (!templateId) return;

        // Remove selection from all cards
        DOM.getAll('.template-card').forEach(card => {
            DOM.removeClass(card, 'selected');
        });

        // Add selection to clicked card
        DOM.addClass(templateCard, 'selected');
        appState.ui.selectedTemplate = templateId;

        // Enable use template button
        const useTemplateBtn = DOM.get('#useTemplateBtn');
        if (useTemplateBtn) {
            useTemplateBtn.disabled = false;
        }
    }

    static handleNotificationsClick = async () => {
        await Dashboard.loadNotifications();
        UI.openModal('notificationsModal');
    };

    static handleMarkNotificationRead = async (notificationId) => {
        try {
            await API.markNotificationRead(notificationId);
            appState.unreadCount = Math.max(0, appState.unreadCount - 1);
            UI.updateNotificationBadge();
            
            // Reload notifications
            await Dashboard.loadNotifications();
        } catch (error) {
            console.error('Failed to mark notification as read:', error);
        }
    };

    static handleMarkAllNotificationsRead = async () => {
        try {
            await API.markAllNotificationsRead();
            appState.unreadCount = 0;
            UI.updateNotificationBadge();
            await Dashboard.loadNotifications();
            UI.showNotification('All notifications marked as read', 'success');
        } catch (error) {
            UI.showNotification('Failed to mark notifications as read', 'error');
        }
    };

    static debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
}

// ==================== DASHBOARD MANAGER ====================
class Dashboard {
    static async init() {
        console.log(' ThoraxLab Dashboard Initializing...');

        // Check authentication
        const isAuthenticated = await this.checkAuth();
        if (!isAuthenticated) {
            window.location.href = 'login.html';
            return;
        }

        // Initialize WebSocket
        WS.connect();

        // Load initial data
        await this.loadInitialData();

        // Setup event listeners
        EventManager.init();

        // Setup window events
        window.addEventListener('beforeunload', () => {
            appState.clearTimeouts();
            WS.disconnect();
        });

        console.log(' Dashboard initialized successfully');
    }

    static async checkAuth() {
        try {
            const userData = localStorage.getItem(CONFIG.LOCAL_STORAGE_KEYS.USER);
            const sessionData = localStorage.getItem(CONFIG.LOCAL_STORAGE_KEYS.SESSION);

            if (!userData || !sessionData) {
                return false;
            }

            appState.user = JSON.parse(userData);
            UI.updateUserInfo();

            // Validate session with server
            await API.getCurrentUser();
            return true;
        } catch (error) {
            console.warn('Authentication check failed:', error);
            this.logout();
            return false;
        }
    }

    static logout() {
        localStorage.removeItem(CONFIG.LOCAL_STORAGE_KEYS.USER);
        localStorage.removeItem(CONFIG.LOCAL_STORAGE_KEYS.SESSION);
        window.location.href = 'login.html';
    }

    static async loadInitialData() {
        UI.showLoading(true);

        try {
            await Promise.all([
                this.loadStats(),
                this.loadProjects(),
                this.checkNotifications()
            ]);
        } catch (error) {
            console.error('Failed to load initial data:', error);
            UI.showNotification('Failed to load dashboard data', 'error');
        } finally {
            UI.showLoading(false);
        }
    }

    static async loadStats() {
        try {
            const response = await API.getDashboardStats();
            if (response.success) {
                appState.stats = response.stats;
                Renderer.renderStats(appState.stats);
            }
        } catch (error) {
            console.error('Failed to load stats:', error);
        }
    }

    static async loadProjects() {
        try {
            const response = await API.getProjects({
                page: appState.currentPage,
                search: appState.filters.search,
                status: appState.filters.status,
                sort: appState.filters.sort
            });

            if (response.success) {
                appState.projects = response.projects;
                appState.pagination = {
                    current: response.pagination.page,
                    total: response.pagination.totalPages,
                    hasNext: response.pagination.page < response.pagination.totalPages,
                    hasPrev: response.pagination.page > 1
                };

                Renderer.renderProjects(appState.projects);
                UI.updatePagination();
            }
        } catch (error) {
            console.error('Failed to load projects:', error);
            UI.showNotification('Failed to load projects', 'error');
        }
    }

    static async loadTemplates() {
        try {
            const response = await API.getTemplates();
            if (response.success) {
                appState.templates = response.templates;
                Renderer.renderTemplates(appState.templates);
            }
        } catch (error) {
            console.error('Failed to load templates:', error);
        }
    }

    static async loadNotifications() {
        try {
            const response = await API.getNotifications();
            if (response.success) {
                appState.notifications = response.notifications;
                Renderer.renderNotifications(appState.notifications);
            }
        } catch (error) {
            console.error('Failed to load notifications:', error);
        }
    }

    static async checkNotifications() {
        try {
            const response = await API.getNotifications();
            if (response.success) {
                appState.unreadCount = response.unreadCount || 0;
                UI.updateNotificationBadge();
            }
        } catch (error) {
            console.error('Failed to check notifications:', error);
        }
    }

    static async loadNextPage() {
        if (appState.pagination.current < appState.pagination.total) {
            appState.currentPage++;
            await this.loadProjects();
        }
    }

    static async loadPrevPage() {
        if (appState.pagination.current > 1) {
            appState.currentPage--;
            await this.loadProjects();
        }
    }
}

// ==================== INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', () => {
    Dashboard.init();
});

// ==================== GLOBAL EXPORTS ====================
window.ThoraxLab = {
    Dashboard,
    UI,
    API,
    WS,
    EventManager,
    Renderer,
    getState: () => appState
};
    </script>
</body>
</html>
