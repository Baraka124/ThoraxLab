<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TH√òRAXLAB | Clinical-Industry Collaboration Hub</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=SF+Mono:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        /* ===== CORE BRAND & STRUCTURE ===== */
        :root {
            --thorax-primary: #1A5F7A;
            --thorax-secondary: #0D8B70;
            --thorax-accent: #6D5ACF;
            --thorax-neutral: #475569;
            --thorax-light: #F8FAFC;
            --thorax-border: #E2E8F0;
            
            --font-display: 'SF Mono', monospace;
            --font-body: 'Inter', sans-serif;
            
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: var(--font-body);
            background: #f8fafc;
            color: var(--thorax-neutral);
            line-height: 1.6;
            min-height: 100vh;
        }
        
        /* ===== BRANDING - TH√òRAXLAB ===== */
        .thoraxlab-brand {
            font-family: var(--font-display);
            font-weight: 600;
            font-size: 1.5rem;
            letter-spacing: -0.5px;
            color: var(--thorax-primary);
            text-decoration: none;
            display: flex;
            align-items: center;
        }
        
        .thoraxlab-brand .zero {
            color: var(--thorax-accent);
            font-weight: 700;
        }
        
        /* ===== HEADER STRUCTURE ===== */
        .header {
            background: white;
            border-bottom: 1px solid var(--thorax-border);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-context {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        /* ===== HERO STRUCTURE ===== */
        .collaboration-hero {
            background: linear-gradient(135deg, var(--thorax-primary) 0%, #14485E 100%);
            color: white;
            padding: 4rem 0;
            margin-bottom: 2rem;
        }
        
        .hero-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }
        
        /* ===== METRICS DASHBOARD STRUCTURE ===== */
        .metrics-dashboard {
            max-width: 1400px;
            margin: 0 auto 3rem;
            padding: 0 1.5rem;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }
        
        .metric-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            border: 1px solid var(--thorax-border);
            transition: all 0.2s;
        }
        
        .metric-card:hover {
            border-color: var(--thorax-accent);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        }
        
        /* ===== BRIDGES SECTION STRUCTURE ===== */
        .bridges-section {
            max-width: 1400px;
            margin: 0 auto 3rem;
            padding: 0 1.5rem;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--thorax-primary);
        }
        
        .bridges-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }
        
        .bridge-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            border: 1px solid var(--thorax-border);
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .bridge-card:hover {
            border-color: var(--thorax-accent);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        }
        
        .bridge-connection {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin: 1rem 0;
            padding: 1rem;
            background: var(--thorax-light);
            border-radius: var(--radius-md);
        }
        
        /* ===== COLLABORATIONS STRUCTURE ===== */
        .collaborations-section {
            max-width: 1400px;
            margin: 0 auto 3rem;
            padding: 0 1.5rem;
        }
        
        .collaborations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .collab-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            border: 1px solid var(--thorax-border);
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .collab-card:hover {
            border-color: var(--thorax-primary);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        }
        
        /* ===== ACTION PANEL STRUCTURE ===== */
        .action-panel {
            max-width: 1400px;
            margin: 0 auto 3rem;
            padding: 0 1.5rem;
        }
        
        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        
        .action-button {
            background: white;
            border: 2px solid var(--thorax-border);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
        }
        
        .action-button:hover {
            border-color: var(--thorax-primary);
            background: var(--thorax-light);
            transform: translateY(-2px);
        }
        
        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .header-container { flex-direction: column; gap: 1rem; }
            .bridges-grid, .collaborations-grid { grid-template-columns: 1fr; }
            .metrics-grid { grid-template-columns: repeat(2, 1fr); }
        }
        
        @media (max-width: 480px) {
            .metrics-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <a href="/" class="thoraxlab-brand">
                TH<span class="zero">√ò</span>RAXLAB
            </a>
            
            <div class="user-context" id="userContext">
                <!-- Dynamic user data from backend -->
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="collaboration-hero">
        <div class="hero-container">
            <h1 class="hero-mission">Bridging Clinical Insight with Industry Innovation</h1>
            <p class="hero-subtitle">
                A platform where thoracic clinicians and medical technology innovators 
                collaborate to advance patient care through evidence-based innovation.
            </p>
        </div>
    </section>

    <!-- Metrics Dashboard -->
    <section class="metrics-dashboard">
        <div class="metrics-grid" id="platformMetrics">
            <!-- Dynamic metrics from backend -->
        </div>
    </section>

    <!-- Active Bridges -->
    <section class="bridges-section">
        <div class="section-header">
            <h2 class="section-title">Active Clinical-Industry Bridges</h2>
        </div>
        
        <div class="bridges-grid" id="activeBridges">
            <!-- Dynamic bridges from backend -->
        </div>
    </section>

    <!-- Your Collaborations -->
    <section class="collaborations-section">
        <div class="section-header">
            <h2 class="section-title">Your Collaborations</h2>
        </div>
        
        <div class="collaborations-grid" id="userCollaborations">
            <!-- Dynamic user projects from backend -->
        </div>
    </section>

    <!-- Action Panel -->
    <section class="action-panel">
        <div class="action-grid">
            <button class="action-button" id="createProjectBtn">
                <div class="action-icon">+</div>
                <div class="action-title">Create New Project</div>
                <div class="action-desc">Start a new clinical-industry collaboration</div>
            </button>
            
            <button class="action-button" id="joinProjectBtn">
                <div class="action-icon">‚Üó</div>
                <div class="action-title">Join Existing Project</div>
                <div class="action-desc">Contribute to ongoing innovations</div>
            </button>
            
            <button class="action-button" id="inviteColleaguesBtn">
                <div class="action-icon">üë•</div>
                <div class="action-title">Invite Colleagues</div>
                <div class="action-desc">Bring clinicians or industry partners</div>
            </button>
        </div>
    </section>

    <script>
        class ThoraxLabDashboard {
            constructor() {
                this.user = null;
                this.projects = [];
                this.metrics = {};
                this.init();
            }
            
            async init() {
                await this.loadUserData();
                await this.loadPlatformMetrics();
                await this.loadActiveBridges();
                await this.loadUserCollaborations();
                this.setupEventListeners();
            }
            
            async loadUserData() {
                try {
                    const response = await fetch('/api/me', { credentials: 'include' });
                    if (response.ok) {
                        const data = await response.json();
                        this.user = data.user;
                        this.renderUserContext();
                    }
                } catch (error) {
                    console.error('Failed to load user data:', error);
                }
            }
            
            async loadPlatformMetrics() {
                try {
                    const response = await fetch('/api/analytics', { credentials: 'include' });
                    if (response.ok) {
                        const data = await response.json();
                        this.metrics = data.analytics;
                        this.renderPlatformMetrics();
                    }
                } catch (error) {
                    console.error('Failed to load metrics:', error);
                }
            }
            
            async loadActiveBridges() {
                try {
                    const response = await fetch('/api/projects/public', { credentials: 'include' });
                    if (response.ok) {
                        const data = await response.json();
                        this.renderActiveBridges(data.projects);
                    }
                } catch (error) {
                    console.error('Failed to load bridges:', error);
                }
            }
            
            async loadUserCollaborations() {
                try {
                    const response = await fetch('/api/projects', { credentials: 'include' });
                    if (response.ok) {
                        const data = await response.json();
                        this.projects = data.projects;
                        this.renderUserCollaborations();
                    }
                } catch (error) {
                    console.error('Failed to load collaborations:', error);
                }
            }
            
            renderUserContext() {
                const container = document.getElementById('userContext');
                if (!container || !this.user) return;
                
                container.innerHTML = `
                    <div class="user-badge">
                        <span class="role-icon ${this.user.role === 'clinician' ? 'role-clinician' : 'role-industry'}">
                            ${this.user.role === 'clinician' ? '‚öïÔ∏è' : 'üè≠'}
                        </span>
                        <div>
                            <div class="user-role">${this.escapeHtml(this.user.name)}</div>
                            <div class="user-org">${this.escapeHtml(this.user.institution)}</div>
                        </div>
                    </div>
                `;
            }
            
            renderPlatformMetrics() {
                const container = document.getElementById('platformMetrics');
                if (!container) return;
                
                container.innerHTML = `
                    <div class="metric-card">
                        <div class="metric-value">${this.metrics.activeBridges || 0}</div>
                        <div class="metric-label">Active Clinical-Industry Bridges</div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-value">${this.metrics.consensusRate || '0%'}</div>
                        <div class="metric-label">Cross-Domain Consensus Rate</div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-value">${this.metrics.avgDecisionTime || '0'}</div>
                        <div class="metric-label">Avg. Decision Velocity (days)</div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-value">${this.metrics.knowledgeExchange || 0}</div>
                        <div class="metric-label">Insights Shared This Month</div>
                    </div>
                `;
            }
            
            renderActiveBridges(projects) {
                const container = document.getElementById('activeBridges');
                if (!container || !projects) return;
                
                if (projects.length === 0) {
                    container.innerHTML = '<p style="text-align: center; padding: 2rem; color: var(--thorax-neutral);">No active bridges available</p>';
                    return;
                }
                
                container.innerHTML = projects.map(project => `
                    <div class="bridge-card" onclick="window.dashboard.viewProject('${project.id}')">
                        <div class="bridge-header">
                            <h3 class="bridge-title">${this.escapeHtml(project.title)}</h3>
                            <span class="bridge-status status-${project.status}">${project.status}</span>
                        </div>
                        
                        <div class="bridge-connection">
                            <div class="connection-side side-clinician">
                                <div class="connection-icon">‚öïÔ∏è</div>
                                <div class="side-info">
                                    <div class="side-title">Clinical Side</div>
                                    <div class="side-count">${project.clinicalCount || 0} Clinicians</div>
                                </div>
                            </div>
                            
                            <div class="connection-arrow">‚Üî</div>
                            
                            <div class="connection-side side-industry">
                                <div class="connection-icon">üè≠</div>
                                <div class="side-info">
                                    <div class="side-title">Industry Side</div>
                                    <div class="side-count">${project.industryCount || 0} Partners</div>
                                </div>
                            </div>
                        </div>
                        
                        <p style="font-size: 0.875rem; color: var(--thorax-neutral); margin-bottom: 1rem;">
                            ${this.escapeHtml(project.description.substring(0, 120))}...
                        </p>
                        
                        <div class="bridge-stats">
                            <div>${project.engagement || 0}% Engagement</div>
                            <div>${project.discussionCount || 0} Discussions</div>
                            <div>${project.phase || 'Planning'}</div>
                        </div>
                    </div>
                `).join('');
            }
            
            renderUserCollaborations() {
                const container = document.getElementById('userCollaborations');
                if (!container) return;
                
                if (this.projects.length === 0) {
                    container.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 3rem;">
                            <p style="color: var(--thorax-neutral); margin-bottom: 1rem;">
                                You're not part of any collaborations yet.
                            </p>
                            <button class="action-button" onclick="document.getElementById('createProjectBtn').click()">
                                Create Your First Project
                            </button>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = this.projects.map(project => `
                    <div class="collab-card" onclick="window.dashboard.viewProject('${project.id}')">
                        <div class="collab-header">
                            <h3 class="collab-title">${this.escapeHtml(project.title)}</h3>
                            <span class="collab-role role-${project.userRole || 'contributor'}">
                                ${project.userRole === 'lead' ? 'Project Lead' : 'Contributor'}
                            </span>
                        </div>
                        
                        <p style="font-size: 0.875rem; color: var(--thorax-neutral); margin-bottom: 1rem;">
                            ${this.escapeHtml(project.description.substring(0, 100))}...
                        </p>
                        
                        <div class="collab-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${project.progress || 0}%"></div>
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; font-size: 0.875rem; color: var(--thorax-neutral);">
                            <div>${project.teamCount || 0} Members</div>
                            <div>${project.discussionCount || 0} Active</div>
                            <div>${this.formatDate(project.updatedAt)}</div>
                        </div>
                    </div>
                `).join('');
            }
            
            setupEventListeners() {
                document.getElementById('createProjectBtn').addEventListener('click', () => {
                    window.location.href = '/create-project.html';
                });
                
                document.getElementById('joinProjectBtn').addEventListener('click', () => {
                    // Show project discovery modal
                    this.showProjectDiscovery();
                });
                
                document.getElementById('inviteColleaguesBtn').addEventListener('click', () => {
                    // Show invitation modal
                    this.showInviteModal();
                });
            }
            
            viewProject(projectId) {
                window.location.href = `/project.html?id=${projectId}`;
            }
            
            // Utility methods
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            formatDate(dateString) {
                try {
                    const date = new Date(dateString);
                    const now = new Date();
                    const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
                    
                    if (diffDays === 0) return 'Today';
                    if (diffDays === 1) return 'Yesterday';
                    if (diffDays < 7) return `${diffDays}d ago`;
                    if (diffDays < 30) return `${Math.floor(diffDays / 7)}w ago`;
                    return date.toLocaleDateString();
                } catch {
                    return 'Recent';
                }
            }
        }
        
        // Initialize dashboard
        window.addEventListener('DOMContentLoaded', () => {
            window.dashboard = new ThoraxLabDashboard();
        });
    </script>
</body>
</html>
