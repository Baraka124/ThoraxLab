<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project | ThoraxLab</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        /* ===== CORE STYLES ===== */
        :root {
            --primary-blue: #1A5F7A;
            --medical-teal: #00A896;
            --error-red: #EF4444;
            --success-green: #10B981;
            --warning-orange: #F59E0B;
            --text-dark: #1E293B;
            --text-medium: #475569;
            --text-light: #64748B;
            --background-gray: #F8FAFC;
            --card-white: #FFFFFF;
            --border-subtle: #E2E8F0;
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;
            --radius-md: 8px;
            --radius-lg: 12px;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--background-gray);
            color: var(--text-dark);
            line-height: 1.6;
        }

        /* ===== UTILITIES ===== */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-sm { gap: var(--space-sm); }
        .gap-md { gap: var(--space-md); }
        .gap-lg { gap: var(--space-lg); }
        .w-full { width: 100%; }
        .mt-md { margin-top: var(--space-md); }
        .mb-md { margin-bottom: var(--space-md); }

        /* ===== LOADING ===== */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-subtle);
            border-top-color: var(--primary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===== NOTIFICATIONS ===== */
        .notification-container {
            position: fixed;
            top: var(--space-lg);
            right: var(--space-lg);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
            max-width: 400px;
            pointer-events: none;
        }

        .notification {
            background: var(--card-white);
            border-radius: var(--radius-lg);
            padding: var(--space-md);
            box-shadow: var(--shadow-lg);
            border-left: 4px solid var(--primary-blue);
            animation: slideIn 0.3s ease;
            pointer-events: auto;
        }

        .notification.error { border-color: var(--error-red); }
        .notification.success { border-color: var(--success-green); }
        .notification.warning { border-color: var(--warning-orange); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* ===== MODAL ===== */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 900;
            padding: var(--space-lg);
        }

        .modal {
            background: var(--card-white);
            border-radius: var(--radius-lg);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: var(--space-lg);
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body { padding: var(--space-lg); }
        .modal-footer {
            padding: var(--space-lg);
            border-top: 1px solid var(--border-subtle);
            display: flex;
            gap: var(--space-md);
            justify-content: flex-end;
        }

        /* ===== HEADER ===== */
        .app-header {
            background: var(--card-white);
            border-bottom: 1px solid var(--border-subtle);
            padding: var(--space-md) 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 var(--space-lg);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            text-decoration: none;
            color: var(--primary-blue);
            font-weight: 700;
            font-size: 1.25rem;
        }

        /* ===== BUTTONS ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
            padding: 0.625rem 1.25rem;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 0.875rem;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            white-space: nowrap;
        }

        .btn-primary {
            background: var(--primary-blue);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #0F4559;
        }

        .btn-secondary {
            background: var(--card-white);
            border-color: var(--border-subtle);
            color: var(--text-dark);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--background-gray);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ===== FORMS ===== */
        .form-group { margin-bottom: var(--space-lg); }
        .form-label {
            display: block;
            margin-bottom: var(--space-sm);
            font-weight: 600;
            color: var(--text-dark);
        }

        .form-input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--border-subtle);
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 0.9375rem;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-blue);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        /* ===== CARDS ===== */
        .card {
            background: var(--card-white);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-subtle);
            overflow: hidden;
        }

        .card-header {
            padding: var(--space-lg);
            border-bottom: 1px solid var(--border-subtle);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .card-body { padding: var(--space-lg); }

        /* ===== PROJECT HEADER ===== */
        .project-header {
            background: linear-gradient(135deg, var(--primary-blue), var(--medical-teal));
            color: white;
            padding: var(--space-2xl) 0;
            margin-bottom: var(--space-xl);
        }

        .project-title {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: var(--space-md);
        }

        .project-description {
            font-size: 1.125rem;
            opacity: 0.9;
            margin-bottom: var(--space-xl);
        }

        .project-meta {
            display: flex;
            gap: var(--space-xl);
            flex-wrap: wrap;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-sm);
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.875rem;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* ===== DISCUSSIONS ===== */
        .discussion-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        .discussion-item {
            padding: var(--space-lg);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            background: var(--card-white);
        }

        .discussion-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-md);
        }

        .discussion-author {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .author-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-blue);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .author-name {
            font-weight: 600;
            color: var(--text-dark);
        }

        .discussion-time {
            font-size: 0.875rem;
            color: var(--text-light);
        }

        .discussion-title {
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: var(--space-sm);
        }

        .discussion-content {
            color: var(--text-medium);
            line-height: 1.6;
            margin-bottom: var(--space-md);
        }

        .discussion-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: var(--space-md);
            border-top: 1px solid var(--border-subtle);
        }

        .vote-btn {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-md);
            transition: all 0.2s;
        }

        .vote-btn:hover {
            background: var(--background-gray);
        }

        .vote-btn.active {
            color: var(--primary-blue);
            font-weight: 600;
        }

        /* ===== TEAM ===== */
        .team-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        .team-member {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-md);
        }

        .member-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--primary-blue);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.125rem;
        }

        .member-info { flex: 1; }
        .member-name { font-weight: 600; }
        .member-role { font-size: 0.875rem; color: var(--text-light); }

        /* ===== METRICS ===== */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-md);
        }

        .metric-card {
            padding: var(--space-lg);
            background: var(--background-gray);
            border-radius: var(--radius-lg);
            text-align: center;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary-blue);
            margin-bottom: var(--space-xs);
        }

        .metric-label {
            font-size: 0.875rem;
            color: var(--text-medium);
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 1024px) {
            .grid-2-col {
                grid-template-columns: 1fr;
                gap: var(--space-lg);
            }
        }

        @media (max-width: 768px) {
            .app-container { padding: 0 var(--space-md); }
            .project-title { font-size: 2rem; }
            .metrics-grid { grid-template-columns: 1fr; }
            .project-meta { gap: var(--space-lg); }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading hidden" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading...</div>
    </div>

    <!-- Notifications -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- Header -->
    <header class="app-header">
        <div class="app-container">
            <div class="header-content">
                <a href="index.html" class="logo">
                    <i class="fas fa-lungs"></i>
                    ThoraxLab
                </a>
                
                <div class="flex items-center gap-md">
                    <a href="index.html" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Dashboard
                    </a>
                    
                    <button class="btn btn-secondary" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Project Header -->
    <div class="project-header">
        <div class="app-container">
            <div id="projectHeader">
                <h1 class="project-title" id="projectTitle">Loading...</h1>
                <p class="project-description" id="projectDescription"></p>
                <div class="flex items-center justify-between">
                    <div class="project-meta" id="projectMeta"></div>
                    <div class="status-badge" id="projectStatus">Loading</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="app-container">
        <div class="grid-2-col" style="display: grid; grid-template-columns: 1fr 380px; gap: var(--space-xl);">
            <!-- Main Column -->
            <div>
                <!-- Project Overview -->
                <div class="card mb-xl">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-clipboard-list"></i>
                            Project Overview
                        </h2>
                        <button class="btn btn-secondary btn-sm" id="editProjectBtn" style="display: none;">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="flex flex-col gap-lg">
                            <div>
                                <h3 class="text-lg font-semibold mb-sm">Objectives</h3>
                                <div id="projectObjectives"></div>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold mb-sm">Timeline</h3>
                                <div id="projectTimeline"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Discussions -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-comments"></i>
                            Discussions
                        </h2>
                        <button class="btn btn-primary btn-sm" id="newDiscussionBtn">
                            <i class="fas fa-plus"></i> New Discussion
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="discussionsContainer">
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-comments text-4xl mb-4"></i>
                                <p>Loading discussions...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div>
                <!-- Team -->
                <div class="card mb-lg">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-users"></i>
                            Team Members
                        </h2>
                    </div>
                    <div class="card-body">
                        <div id="teamContainer">
                            <div class="text-center py-4 text-gray-500">
                                Loading team...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Metrics -->
                <div class="card mb-lg">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-chart-bar"></i>
                            Project Metrics
                        </h2>
                        <button class="btn btn-secondary btn-sm" id="refreshMetricsBtn">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="metricsContainer">
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-value">--</div>
                                    <div class="metric-label">Consensus</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value">--</div>
                                    <div class="metric-label">Engagement</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-bolt"></i>
                            Quick Actions
                        </h2>
                    </div>
                    <div class="card-body">
                        <div class="flex flex-col gap-sm">
                            <button class="btn btn-primary w-full justify-start" id="shareProjectBtn">
                                <i class="fas fa-share-alt"></i> Share Project
                            </button>
                            <button class="btn btn-secondary w-full justify-start" id="exportProjectBtn">
                                <i class="fas fa-download"></i> Export Data
                            </button>
                            <button class="btn btn-secondary w-full justify-start" id="projectSettingsBtn">
                                <i class="fas fa-cog"></i> Settings
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div class="modal-backdrop hidden" id="modalBackdrop">
        <div class="modal" id="modal"></div>
    </div>

    <script>
        // ==================== GLOBAL STATE ====================
        const ThoraxLab = {
            // Configuration
            config: {
                API_BASE: window.location.origin,
                STORAGE_KEYS: {
                    USER: 'thoraxlab_user',
                    SESSION: 'thoraxlab_session'
                }
            },

            // State
            state: {
                user: null,
                session: null,
                project: null,
                discussions: [],
                team: [],
                metrics: {},
                socket: null,
                onlineUsers: new Set(),
                userVotes: new Map()
            },

            // Initialize
            async init() {
                console.log('ðŸš€ ThoraxLab Project System Initializing...');
                
                // Check authentication
                if (!await this.checkAuth()) {
                    window.location.href = 'login.html';
                    return;
                }

                // Get project ID from URL
                const projectId = this.getProjectIdFromURL();
                if (!projectId) {
                    this.showNotification('error', 'No Project', 'Project ID not found in URL');
                    setTimeout(() => window.location.href = 'index.html', 2000);
                    return;
                }

                // Setup event listeners
                this.setupEventListeners();

                // Initialize WebSocket
                await this.initSocket();

                // Load project data
                await this.loadProject(projectId);

                console.log('âœ… ThoraxLab ready');
            },

            // ==================== AUTHENTICATION ====================
            async checkAuth() {
                try {
                    const userData = localStorage.getItem(this.config.STORAGE_KEYS.USER);
                    const sessionData = localStorage.getItem(this.config.STORAGE_KEYS.SESSION);
                    
                    if (!userData || !sessionData) {
                        return false;
                    }

                    const user = JSON.parse(userData);
                    const session = JSON.parse(sessionData);
                    
                    // Validate session expiration
                    if (new Date(session.expiresAt) < new Date()) {
                        this.logout();
                        return false;
                    }

                    this.state.user = user;
                    this.state.session = session;
                    
                    return true;
                } catch (error) {
                    console.error('Auth check failed:', error);
                    return false;
                }
            },

            getProjectIdFromURL() {
                const params = new URLSearchParams(window.location.search);
                return params.get('id');
            },

            // ==================== API SERVICE ====================
            async apiRequest(endpoint, options = {}) {
                const url = `${this.config.API_BASE}${endpoint}`;
                const headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${this.state.session?.id}`,
                    ...options.headers
                };

                const config = {
                    headers,
                    ...options
                };

                if (config.body && typeof config.body !== 'string') {
                    config.body = JSON.stringify(config.body);
                }

                this.showLoading('Loading...');

                try {
                    const response = await fetch(url, config);
                    
                    if (response.status === 401) {
                        this.logout();
                        throw new Error('Session expired');
                    }

                    if (!response.ok) {
                        const error = await response.json().catch(() => ({ error: 'Request failed' }));
                        throw new Error(error.error || `HTTP ${response.status}`);
                    }

                    return await response.json();
                } catch (error) {
                    console.error(`API request failed: ${url}`, error);
                    this.showNotification('error', 'Request Failed', error.message);
                    throw error;
                } finally {
                    this.hideLoading();
                }
            },

            // ==================== SOCKET.IO ====================
            async initSocket() {
                if (!this.state.session?.id) return;

                this.state.socket = io(this.config.API_BASE, {
                    auth: {
                        sessionId: this.state.session.id
                    },
                    reconnection: true,
                    reconnectionAttempts: 5
                });

                this.state.socket.on('connect', () => {
                    console.log('âœ… WebSocket connected');
                    
                    // Join project room
                    const projectId = this.getProjectIdFromURL();
                    if (projectId) {
                        this.state.socket.emit('join:project', projectId);
                    }
                });

                this.state.socket.on('authenticated', (data) => {
                    console.log('âœ… Socket authenticated:', data.userId);
                });

                this.state.socket.on('discussion:created', (data) => {
                    console.log('New discussion from socket:', data);
                    this.handleNewDiscussion(data);
                });

                this.state.socket.on('comment:added', (data) => {
                    console.log('New comment from socket:', data);
                    this.handleNewComment(data);
                });

                this.state.socket.on('discussion:vote:update', (data) => {
                    console.log('Vote update from socket:', data);
                    this.handleVoteUpdate(data);
                });

                this.state.socket.on('user:joined', (data) => {
                    console.log('User joined:', data);
                    this.handleUserJoined(data);
                });

                this.state.socket.on('user:left', (data) => {
                    console.log('User left:', data);
                    this.handleUserLeft(data);
                });

                this.state.socket.on('user:typing', (data) => {
                    console.log('User typing:', data);
                    this.handleTyping(data);
                });

                this.state.socket.on('error', (data) => {
                    console.error('Socket error:', data);
                    this.showNotification('error', 'Connection Error', data.error);
                });

                this.state.socket.on('disconnect', () => {
                    console.log('ðŸ”Œ WebSocket disconnected');
                });
            },

            // ==================== PROJECT MANAGEMENT ====================
            async loadProject(projectId) {
                try {
                    const data = await this.apiRequest(`/api/projects/${projectId}`);
                    
                    if (data.success) {
                        this.state.project = data.project;
                        this.renderProject();
                        
                        // Load discussions
                        await this.loadDiscussions(projectId);
                        
                        // Load metrics
                        await this.loadMetrics();
                        
                        // Update team from project data
                        this.updateTeamFromProject(data.project);
                    } else {
                        throw new Error(data.error || 'Failed to load project');
                    }
                } catch (error) {
                    console.error('Failed to load project:', error);
                    this.showErrorState('Failed to load project');
                }
            },

            async loadDiscussions(projectId) {
                try {
                    const data = await this.apiRequest(`/api/projects/${projectId}/discussions`);
                    
                    if (data.success) {
                        this.state.discussions = data.discussions;
                        this.renderDiscussions();
                    }
                } catch (error) {
                    console.error('Failed to load discussions:', error);
                }
            },

            async loadMetrics() {
                try {
                    const data = await this.apiRequest(`/api/stats`);
                    
                    if (data.success) {
                        this.state.metrics = data.stats;
                        this.renderMetrics();
                    }
                } catch (error) {
                    console.error('Failed to load metrics:', error);
                }
            },

            updateTeamFromProject(project) {
                this.state.team = project.team || [];
                this.renderTeam();
            },

            // ==================== DISCUSSION MANAGEMENT ====================
            async createDiscussion(title, content, tags = []) {
                const projectId = this.getProjectIdFromURL();
                if (!projectId) return;

                try {
                    if (this.state.socket?.connected) {
                        // Use WebSocket for real-time
                        return new Promise((resolve, reject) => {
                            this.state.socket.emit('discussion:create', {
                                projectId,
                                title,
                                content,
                                tags
                            });
                            
                            this.state.socket.once('discussion:created:confirm', (data) => {
                                resolve(data);
                            });
                            
                            setTimeout(() => reject(new Error('Timeout')), 5000);
                        });
                    } else {
                        // Fallback to HTTP (needs server endpoint)
                        this.showNotification('warning', 'Real-time disabled', 'Using HTTP fallback');
                        throw new Error('WebSocket not connected');
                    }
                } catch (error) {
                    console.error('Failed to create discussion:', error);
                    throw error;
                }
            },

            async addComment(discussionId, content) {
                try {
                    if (this.state.socket?.connected) {
                        return new Promise((resolve, reject) => {
                            this.state.socket.emit('comment:add', {
                                discussionId,
                                content
                            });
                            
                            this.state.socket.once('comment:added:confirm', (data) => {
                                resolve(data);
                            });
                            
                            setTimeout(() => reject(new Error('Timeout')), 5000);
                        });
                    } else {
                        throw new Error('WebSocket not connected');
                    }
                } catch (error) {
                    console.error('Failed to add comment:', error);
                    throw error;
                }
            },

            async voteDiscussion(discussionId, voteType) {
                try {
                    if (this.state.socket?.connected) {
                        this.state.socket.emit('discussion:vote', {
                            discussionId,
                            voteType
                        });
                    } else {
                        throw new Error('WebSocket not connected');
                    }
                } catch (error) {
                    console.error('Failed to vote:', error);
                    this.showNotification('error', 'Vote Failed', error.message);
                }
            },

            // ==================== EVENT HANDLERS ====================
            handleNewDiscussion(discussion) {
                // Add to state if not already present
                if (!this.state.discussions.find(d => d.id === discussion.id)) {
                    this.state.discussions.unshift(discussion);
                    this.renderDiscussions();
                    
                    // Show notification if not from current user
                    if (discussion.authorId !== this.state.user?.id) {
                        this.showNotification('info', 'New Discussion', 
                            `${discussion.author} started a new discussion`);
                    }
                }
            },

            handleNewComment(data) {
                const discussion = this.state.discussions.find(d => d.id === data.discussionId);
                if (discussion) {
                    if (!discussion.comments) discussion.comments = [];
                    discussion.comments.push(data.comment);
                    this.renderDiscussions();
                    
                    // Show notification if comment not from current user
                    if (data.comment.authorId !== this.state.user?.id) {
                        this.showNotification('info', 'New Comment',
                            `${data.comment.author} commented on a discussion`);
                    }
                }
            },

            handleVoteUpdate(data) {
                const discussion = this.state.discussions.find(d => d.id === data.discussionId);
                if (discussion) {
                    discussion.upvotes = data.upvotes;
                    discussion.downvotes = data.downvotes;
                    
                    // Update user's vote
                    if (data.userVote !== undefined) {
                        this.state.userVotes.set(data.discussionId, data.userVote);
                    }
                    
                    this.renderDiscussions();
                }
            },

            handleUserJoined(data) {
                this.state.onlineUsers.add(data.userId);
                this.showNotification('info', 'User Joined', `${data.userName} joined the project`);
            },

            handleUserLeft(data) {
                this.state.onlineUsers.delete(data.userId);
                this.showNotification('info', 'User Left', 'A user left the project');
            },

            handleTyping(data) {
                // Could implement typing indicators in UI
                console.log('Typing:', data);
            },

            // ==================== UI RENDERING ====================
            renderProject() {
                const project = this.state.project;
                if (!project) return;

                // Title and description
                document.getElementById('projectTitle').textContent = project.title;
                document.getElementById('projectDescription').textContent = project.description;

                // Status badge
                const statusEl = document.getElementById('projectStatus');
                statusEl.textContent = project.status?.charAt(0).toUpperCase() + project.status?.slice(1) || 'Unknown';
                statusEl.className = `status-badge ${project.status || 'planning'}`;

                // Metadata
                const metaEl = document.getElementById('projectMeta');
                metaEl.innerHTML = `
                    <div class="meta-item">
                        <i class="fas fa-user-md"></i>
                        <div>
                            <div class="meta-label">Lead</div>
                            <div class="meta-value">${project.lead || 'Unknown'}</div>
                        </div>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-calendar-alt"></i>
                        <div>
                            <div class="meta-label">Start Date</div>
                            <div class="meta-value">${project.startDate ? new Date(project.startDate).toLocaleDateString() : 'Not set'}</div>
                        </div>
                    </div>
                `;

                // Show edit button if user is lead
                const editBtn = document.getElementById('editProjectBtn');
                if (project.leadId === this.state.user?.id) {
                    editBtn.style.display = 'inline-flex';
                }

                // Objectives
                const objectivesEl = document.getElementById('projectObjectives');
                objectivesEl.innerHTML = project.objectives?.map(obj => 
                    `<div class="flex items-center gap-sm mb-sm">
                        <i class="fas fa-check text-success-green"></i>
                        <span>${this.escapeHtml(obj)}</span>
                    </div>`
                ).join('') || '<p class="text-gray-500">No objectives defined</p>';

                // Timeline
                const timelineEl = document.getElementById('projectTimeline');
                if (project.timeline) {
                    timelineEl.innerHTML = `
                        <div class="flex items-center justify-between mb-sm">
                            <span>Progress</span>
                            <span>${project.timeline.progressPercentage || 0}%</span>
                        </div>
                        <div style="height: 8px; background: var(--border-subtle); border-radius: 4px; overflow: hidden;">
                            <div style="width: ${project.timeline.progressPercentage || 0}%; height: 100%; background: var(--primary-blue);"></div>
                        </div>
                        <div class="text-sm text-gray-600 mt-2">
                            ${project.timeline.daysRemaining !== undefined ? 
                                `${project.timeline.daysRemaining} days remaining` : 
                                'Timeline not available'}
                        </div>
                    `;
                } else {
                    timelineEl.innerHTML = '<p class="text-gray-500">Timeline not available</p>';
                }
            },

            renderDiscussions() {
                const container = document.getElementById('discussionsContainer');
                
                if (this.state.discussions.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-comments text-4xl mb-4"></i>
                            <p>No discussions yet. Start the conversation!</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.state.discussions.map(discussion => {
                    const userVote = this.state.userVotes.get(discussion.id);
                    const commentCount = discussion.comments?.length || 0;
                    
                    return `
                        <div class="discussion-item" data-id="${discussion.id}">
                            <div class="discussion-header">
                                <div class="discussion-author">
                                    <div class="author-avatar">${discussion.author?.charAt(0) || 'U'}</div>
                                    <div>
                                        <div class="author-name">${this.escapeHtml(discussion.author || 'Unknown')}</div>
                                        <div class="discussion-time">${this.formatTimeAgo(discussion.createdAt)}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <h3 class="discussion-title">${this.escapeHtml(discussion.title)}</h3>
                            <div class="discussion-content">${this.escapeHtml(discussion.content)}</div>
                            
                            <div class="discussion-footer">
                                <div class="flex gap-md">
                                    <button class="vote-btn ${userVote === 'up' ? 'active' : ''}" 
                                            onclick="ThoraxLab.voteDiscussion('${discussion.id}', 'up')">
                                        <i class="fas fa-thumbs-up"></i>
                                        <span>${discussion.upvotes || 0}</span>
                                    </button>
                                    
                                    <button class="vote-btn ${userVote === 'down' ? 'active' : ''}"
                                            onclick="ThoraxLab.voteDiscussion('${discussion.id}', 'down')">
                                        <i class="fas fa-thumbs-down"></i>
                                        <span>${discussion.downvotes || 0}</span>
                                    </button>
                                    
                                    <button class="vote-btn" onclick="ThoraxLab.showComments('${discussion.id}')">
                                        <i class="fas fa-comment"></i>
                                        <span>${commentCount}</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            renderTeam() {
                const container = document.getElementById('teamContainer');
                
                if (this.state.team.length === 0) {
                    container.innerHTML = '<div class="text-center py-4 text-gray-500">No team members</div>';
                    return;
                }

                container.innerHTML = this.state.team.map(member => {
                    const isOnline = this.state.onlineUsers.has(member.id);
                    
                    return `
                        <div class="team-member">
                            <div class="member-avatar">${member.name?.charAt(0) || 'U'}</div>
                            <div class="member-info">
                                <div class="member-name">${this.escapeHtml(member.name || 'Unknown')}</div>
                                <div class="member-role">${this.escapeHtml(member.role || 'Team Member')}</div>
                            </div>
                            <div style="width: 10px; height: 10px; border-radius: 50%; 
                                       background: ${isOnline ? 'var(--success-green)' : 'var(--text-light)'};"></div>
                        </div>
                    `;
                }).join('');
            },

            renderMetrics() {
                const container = document.getElementById('metricsContainer');
                const metrics = this.state.metrics;
                
                container.innerHTML = `
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-value">${metrics.consensusRate || '--'}%</div>
                            <div class="metric-label">Consensus</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">${metrics.engagementScore || '--'}</div>
                            <div class="metric-label">Engagement</div>
                        </div>
                    </div>
                `;
            },

            // ==================== MODAL SYSTEM ====================
            showModal(title, content, buttons = []) {
                const modal = document.getElementById('modal');
                const backdrop = document.getElementById('modalBackdrop');
                
                modal.innerHTML = `
                    <div class="modal-header">
                        <h2 class="text-xl font-bold">${title}</h2>
                        <button class="btn btn-secondary btn-sm" onclick="ThoraxLab.closeModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">${content}</div>
                    ${buttons.length > 0 ? `
                        <div class="modal-footer">
                            ${buttons.map(btn => `
                                <button class="btn ${btn.primary ? 'btn-primary' : 'btn-secondary'}"
                                        onclick="${btn.onclick}">
                                    ${btn.text}
                                </button>
                            `).join('')}
                        </div>
                    ` : ''}
                `;
                
                backdrop.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            },

            closeModal() {
                const backdrop = document.getElementById('modalBackdrop');
                backdrop.classList.add('hidden');
                document.body.style.overflow = '';
            },

            // ==================== MODAL FORMS ====================
            showNewDiscussionModal() {
                const content = `
                    <div class="form-group">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-input" id="discussionTitle" placeholder="Enter discussion title">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Content</label>
                        <textarea class="form-input form-textarea" id="discussionContent" placeholder="Describe your discussion..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tags (comma separated)</label>
                        <input type="text" class="form-input" id="discussionTags" placeholder="e.g., methodology, results, ethics">
                    </div>
                `;
                
                this.showModal('New Discussion', content, [
                    {
                        text: 'Cancel',
                        onclick: 'ThoraxLab.closeModal()'
                    },
                    {
                        text: 'Create',
                        primary: true,
                        onclick: `ThoraxLab.submitNewDiscussion()`
                    }
                ]);
            },

            async submitNewDiscussion() {
                const title = document.getElementById('discussionTitle').value.trim();
                const content = document.getElementById('discussionContent').value.trim();
                const tags = document.getElementById('discussionTags').value
                    .split(',')
                    .map(tag => tag.trim())
                    .filter(tag => tag.length > 0);

                if (!title || !content) {
                    this.showNotification('error', 'Validation Error', 'Title and content are required');
                    return;
                }

                try {
                    await this.createDiscussion(title, content, tags);
                    this.showNotification('success', 'Discussion Created', 'Your discussion has been posted');
                    this.closeModal();
                } catch (error) {
                    this.showNotification('error', 'Failed to Create', error.message);
                }
            },

            showComments(discussionId) {
                const discussion = this.state.discussions.find(d => d.id === discussionId);
                if (!discussion) return;

                const comments = discussion.comments || [];
                
                const content = `
                    <div class="mb-lg">
                        <h3 class="font-bold text-lg mb-2">${this.escapeHtml(discussion.title)}</h3>
                        <p class="text-gray-700">${this.escapeHtml(discussion.content)}</p>
                    </div>
                    
                    <div class="border-t pt-4">
                        <h4 class="font-bold mb-4">Comments (${comments.length})</h4>
                        
                        ${comments.length === 0 ? `
                            <p class="text-gray-500 text-center py-4">No comments yet. Be the first to comment!</p>
                        ` : `
                            <div class="space-y-4">
                                ${comments.map(comment => `
                                    <div class="p-3 bg-gray-50 rounded-lg">
                                        <div class="flex justify-between items-start mb-2">
                                            <span class="font-semibold">${this.escapeHtml(comment.author)}</span>
                                            <span class="text-sm text-gray-500">${this.formatTimeAgo(comment.timestamp)}</span>
                                        </div>
                                        <p class="text-gray-700">${this.escapeHtml(comment.content)}</p>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                        
                        <div class="mt-6">
                            <h5 class="font-semibold mb-2">Add a comment</h5>
                            <textarea class="form-input form-textarea" id="commentInput" rows="3"></textarea>
                        </div>
                    </div>
                `;

                this.showModal('Discussion Comments', content, [
                    {
                        text: 'Cancel',
                        onclick: 'ThoraxLab.closeModal()'
                    },
                    {
                        text: 'Post Comment',
                        primary: true,
                        onclick: `ThoraxLab.submitComment('${discussionId}')`
                    }
                ]);
            },

            async submitComment(discussionId) {
                const input = document.getElementById('commentInput');
                const content = input?.value.trim();

                if (!content) {
                    this.showNotification('error', 'Validation Error', 'Please enter a comment');
                    return;
                }

                try {
                    await this.addComment(discussionId, content);
                    this.showNotification('success', 'Comment Posted', 'Your comment has been added');
                    input.value = '';
                } catch (error) {
                    this.showNotification('error', 'Failed to Comment', error.message);
                }
            },

            // ==================== UTILITIES ====================
            showLoading(message) {
                const overlay = document.getElementById('loadingOverlay');
                const text = document.getElementById('loadingText');
                
                if (overlay && text) {
                    text.textContent = message;
                    overlay.classList.remove('hidden');
                }
            },

            hideLoading() {
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    overlay.classList.add('hidden');
                }
            },

            showNotification(type, title, message) {
                const container = document.getElementById('notificationContainer');
                const notification = document.createElement('div');
                
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <div class="font-semibold">${this.escapeHtml(title)}</div>
                    <div class="text-sm">${this.escapeHtml(message)}</div>
                `;
                
                container.appendChild(notification);
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.style.opacity = '0';
                        notification.style.transform = 'translateX(100%)';
                        setTimeout(() => notification.remove(), 300);
                    }
                }, 5000);
            },

            showErrorState(message) {
                const header = document.getElementById('projectHeader');
                if (header) {
                    header.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-exclamation-triangle text-4xl text-error-red mb-4"></i>
                            <h2 class="text-2xl font-bold mb-2">Error</h2>
                            <p class="text-gray-600 mb-4">${this.escapeHtml(message)}</p>
                            <a href="index.html" class="btn btn-primary">
                                <i class="fas fa-arrow-left"></i> Back to Dashboard
                            </a>
                        </div>
                    `;
                }
            },

            formatTimeAgo(timestamp) {
                if (!timestamp) return 'Unknown time';
                
                const date = new Date(timestamp);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);
                
                if (diffMins < 60) return `${diffMins}m ago`;
                if (diffHours < 24) return `${diffHours}h ago`;
                if (diffDays < 7) return `${diffDays}d ago`;
                return date.toLocaleDateString();
            },

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },

            // ==================== EVENT LISTENERS ====================
            setupEventListeners() {
                // Logout button
                document.getElementById('logoutBtn').addEventListener('click', () => this.logout());
                
                // New discussion button
                document.getElementById('newDiscussionBtn').addEventListener('click', () => {
                    this.showNewDiscussionModal();
                });
                
                // Refresh metrics button
                document.getElementById('refreshMetricsBtn').addEventListener('click', () => {
                    this.loadMetrics();
                });
                
                // Quick action buttons
                document.getElementById('shareProjectBtn').addEventListener('click', () => {
                    this.shareProject();
                });
                
                document.getElementById('exportProjectBtn').addEventListener('click', () => {
                    this.exportProject();
                });
                
                document.getElementById('projectSettingsBtn').addEventListener('click', () => {
                    this.showProjectSettings();
                });
                
                // Edit project button
                const editBtn = document.getElementById('editProjectBtn');
                if (editBtn) {
                    editBtn.addEventListener('click', () => {
                        this.showEditProjectModal();
                    });
                }
                
                // Close modal on backdrop click
                document.getElementById('modalBackdrop').addEventListener('click', (e) => {
                    if (e.target === e.currentTarget) {
                        this.closeModal();
                    }
                });
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.closeModal();
                    }
                    
                    // Ctrl/Cmd + N for new discussion
                    if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                        e.preventDefault();
                        this.showNewDiscussionModal();
                    }
                });
            },

            // ==================== QUICK ACTIONS ====================
            async shareProject() {
                const projectId = this.getProjectIdFromURL();
                const shareUrl = `${window.location.origin}${window.location.pathname}?id=${projectId}`;
                
                const content = `
                    <div class="form-group">
                        <label class="form-label">Share Link</label>
                        <div class="flex gap-2">
                            <input type="text" class="form-input" value="${shareUrl}" readonly>
                            <button class="btn btn-primary" onclick="navigator.clipboard.writeText('${shareUrl}').then(() => ThoraxLab.showNotification('success', 'Copied', 'Link copied to clipboard'))">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                this.showModal('Share Project', content, [
                    {
                        text: 'Close',
                        onclick: 'ThoraxLab.closeModal()'
                    }
                ]);
            },

            async exportProject() {
                const projectId = this.getProjectIdFromURL();
                
                try {
                    const data = await this.apiRequest(`/api/projects/${projectId}/export`);
                    
                    if (data.success) {
                        // Create download link
                        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `thoraxlab-project-${projectId}-${new Date().toISOString().split('T')[0]}.json`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        
                        this.showNotification('success', 'Export Complete', 'Project data exported successfully');
                    }
                } catch (error) {
                    console.error('Export failed:', error);
                }
            },

            showProjectSettings() {
                const content = `
                    <div class="space-y-4">
                        <div class="form-group">
                            <label class="form-label">Notifications</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" checked class="mr-2">
                                    New discussions
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" checked class="mr-2">
                                    New comments
                                </label>
                            </div>
                        </div>
                        
                        <div class="border-t pt-4">
                            <h4 class="font-semibold mb-2 text-red-600">Danger Zone</h4>
                            <button class="btn btn-secondary w-full justify-start text-red-600" onclick="ThoraxLab.showArchiveConfirm()">
                                <i class="fas fa-archive"></i> Archive Project
                            </button>
                        </div>
                    </div>
                `;
                
                this.showModal('Project Settings', content, [
                    {
                        text: 'Cancel',
                        onclick: 'ThoraxLab.closeModal()'
                    },
                    {
                        text: 'Save Settings',
                        primary: true,
                        onclick: 'ThoraxLab.closeModal()'
                    }
                ]);
            },

            showEditProjectModal() {
                const project = this.state.project;
                if (!project) return;

                const content = `
                    <div class="form-group">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-input" id="editProjectTitle" value="${this.escapeHtml(project.title)}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-input form-textarea" id="editProjectDescription" rows="4">${this.escapeHtml(project.description)}</textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-input" id="editProjectStatus">
                            <option value="planning" ${project.status === 'planning' ? 'selected' : ''}>Planning</option>
                            <option value="active" ${project.status === 'active' ? 'selected' : ''}>Active</option>
                            <option value="completed" ${project.status === 'completed' ? 'selected' : ''}>Completed</option>
                        </select>
                    </div>
                `;

                this.showModal('Edit Project', content, [
                    {
                        text: 'Cancel',
                        onclick: 'ThoraxLab.closeModal()'
                    },
                    {
                        text: 'Save Changes',
                        primary: true,
                        onclick: `ThoraxLab.submitEditProject()`
                    }
                ]);
            },

            async submitEditProject() {
                const projectId = this.getProjectIdFromURL();
                const title = document.getElementById('editProjectTitle').value.trim();
                const description = document.getElementById('editProjectDescription').value.trim();
                const status = document.getElementById('editProjectStatus').value;

                if (!title || !description) {
                    this.showNotification('error', 'Validation Error', 'Title and description are required');
                    return;
                }

                try {
                    const data = await this.apiRequest(`/api/projects/${projectId}`, {
                        method: 'PUT',
                        body: { title, description, status }
                    });

                    if (data.success) {
                        this.state.project = data.project;
                        this.renderProject();
                        this.showNotification('success', 'Project Updated', 'Changes saved successfully');
                        this.closeModal();
                    }
                } catch (error) {
                    this.showNotification('error', 'Update Failed', error.message);
                }
            },

            showArchiveConfirm() {
                if (confirm('Are you sure you want to archive this project? Archived projects are read-only.')) {
                    this.showNotification('info', 'Feature Coming', 'Archive functionality coming soon');
                }
            },

            // ==================== LOGOUT ====================
            async logout() {
                if (confirm('Are you sure you want to logout?')) {
                    try {
                        await this.apiRequest('/api/logout', { method: 'POST' });
                    } catch (error) {
                        // Continue with logout even if API fails
                    }
                    
                    localStorage.removeItem(this.config.STORAGE_KEYS.USER);
                    localStorage.removeItem(this.config.STORAGE_KEYS.SESSION);
                    
                    if (this.state.socket) {
                        this.state.socket.disconnect();
                    }
                    
                    window.location.href = 'login.html';
                }
            }
        };

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', () => {
            // Make ThoraxLab globally available
            window.ThoraxLab = ThoraxLab;
            
            // Initialize the application
            ThoraxLab.init().catch(error => {
                console.error('Failed to initialize:', error);
                ThoraxLab.showNotification('error', 'Initialization Failed', 'Failed to load application');
            });
        });
    </script>
</body>
</html>
