<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Project Details | ThoraxLab</title>
    <style>
        /* ===== REUSE STYLES FROM INDEX.HTML ===== */
        :root {
            --primary-900: #0A2463;
            --primary-800: #1A365D;
            --primary-700: #2D3748;
            --primary-600: #4A5568;
            --primary-500: #718096;
            --primary-400: #A0AEC0;
            --primary-300: #CBD5E0;
            --primary-200: #E2E8F0;
            --primary-100: #EDF2F7;
            --primary-50: #F7FAFC;
            
            --accent-blue: #2D9CDB;
            --accent-teal: #38B2AC;
            --accent-green: #27AE60;
            --accent-amber: #F6AD55;
            --accent-red: #E53E3E;
            
            --success: var(--accent-green);
            --warning: var(--accent-amber);
            --error: var(--accent-red);
            --info: var(--accent-blue);
            
            --space-0: 0;
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-5: 1.25rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            --space-10: 2.5rem;
            --space-12: 3rem;
            --space-16: 4rem;
            
            --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
            --radius-full: 9999px;
            
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            -webkit-tap-highlight-color: transparent;
        }
        
        html {
            font-size: 16px;
        }
        
        body {
            font-family: var(--font-sans);
            font-weight: 400;
            line-height: 1.6;
            color: var(--primary-800);
            background: linear-gradient(135deg, var(--primary-50) 0%, #FFFFFF 100%);
            min-height: 100vh;
        }
        
        /* ===== TYPOGRAPHY ===== */
        h1 { font-size: 2.5rem; font-weight: 800; }
        h2 { font-size: 2rem; font-weight: 700; }
        h3 { font-size: 1.5rem; font-weight: 700; }
        h4 { font-size: 1.25rem; font-weight: 600; }
        
        .text-display { font-size: 3rem; font-weight: 800; }
        .text-lead { font-size: 1.25rem; color: var(--primary-600); }
        .text-body { font-size: 1rem; }
        .text-small { font-size: 0.875rem; color: var(--primary-500); }
        .text-micro { font-size: 0.75rem; color: var(--primary-400); }
        
        /* ===== BUTTONS ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            font-family: var(--font-sans);
            font-weight: 600;
            font-size: 0.9375rem;
            line-height: 1;
            text-decoration: none;
            cursor: pointer;
            border: none;
            outline: none;
            transition: all var(--transition-base);
            user-select: none;
            min-height: 44px;
            padding: var(--space-3) var(--space-6);
            border-radius: var(--radius-full);
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-800) 0%, var(--accent-blue) 100%);
            color: white;
            box-shadow: var(--shadow-md);
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn-secondary {
            background: transparent;
            color: var(--primary-800);
            border: 2px solid var(--primary-300);
            box-shadow: var(--shadow-sm);
        }
        
        .btn-secondary:hover:not(:disabled) {
            border-color: var(--primary-800);
            background: var(--primary-50);
        }
        
        .btn-tertiary {
            background: transparent;
            color: var(--primary-800);
            padding: var(--space-2) var(--space-4);
            min-height: 36px;
        }
        
        .btn-sm { padding: var(--space-2) var(--space-4); min-height: 36px; font-size: 0.875rem; }
        .btn-lg { padding: var(--space-4) var(--space-8); min-height: 52px; font-size: 1.0625rem; }
        
        .btn-loading {
            position: relative;
            color: transparent !important;
        }
        
        .btn-loading::after {
            content: "";
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ===== LAYOUT ===== */
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 var(--space-4);
        }
        
        @media (min-width: 1024px) {
            .container { padding: 0 var(--space-8); }
        }
        
        .grid {
            display: grid;
            gap: var(--space-6);
        }
        
        .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        
        @media (min-width: 768px) {
            .md\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
            .md\:grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
        }
        
        @media (min-width: 1024px) {
            .lg\:grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
        }
        
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .items-start { align-items: flex-start; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: var(--space-2); }
        .gap-3 { gap: var(--space-3); }
        .gap-4 { gap: var(--space-4); }
        .gap-6 { gap: var(--space-6); }
        .gap-8 { gap: var(--space-8); }
        
        /* ===== HEADER ===== */
        .header {
            background: white;
            border-bottom: 1px solid var(--primary-200);
            position: sticky;
            top: 0;
            z-index: 20;
            backdrop-filter: blur(10px);
        }
        
        .header-content {
            padding: var(--space-4) 0;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            text-decoration: none;
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-800) 0%, var(--accent-blue) 100%);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            font-size: 1.25rem;
        }
        
        /* ===== PROJECT HEADER ===== */
        .project-header {
            background: white;
            border-radius: var(--radius-xl);
            padding: var(--space-8);
            margin: var(--space-8) 0;
            box-shadow: var(--shadow-md);
            border-left: 6px solid var(--accent-blue);
        }
        
        .project-stage-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-full);
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: var(--space-4);
        }
        
        .stage-idea { background: #FEF3C7; color: #92400E; }
        .stage-planning { background: #DBEAFE; color: #1E40AF; }
        .stage-active { background: #D1FAE5; color: #065F46; }
        .stage-review { background: #E0E7FF; color: #3730A3; }
        .stage-completed { background: #F3F4F6; color: #374151; }
        
        .project-meta {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-4);
            margin: var(--space-4) 0;
        }
        
        .meta-item {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            background: var(--primary-100);
            color: var(--primary-700);
            border-radius: var(--radius-full);
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        /* ===== PULSE DISPLAY ===== */
        .pulse-card {
            background: white;
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            box-shadow: var(--shadow-md);
            text-align: center;
        }
        
        .pulse-value {
            font-size: 3.5rem;
            font-weight: 800;
            line-height: 1;
            margin-bottom: var(--space-2);
            transition: all var(--transition-slow);
        }
        
        .pulse-label {
            font-size: 1rem;
            color: var(--primary-500);
            font-weight: 600;
            margin-bottom: var(--space-4);
        }
        
        .pulse-bar {
            width: 100%;
            height: 12px;
            background: var(--primary-200);
            border-radius: var(--radius-full);
            overflow: hidden;
            margin: var(--space-4) 0;
        }
        
        .pulse-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-red) 0%, var(--accent-amber) 50%, var(--accent-green) 100%);
            border-radius: var(--radius-full);
            transition: width 1s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .pulse-description {
            font-size: 0.875rem;
            color: var(--primary-500);
            margin-top: var(--space-2);
        }
        
        /* ===== DISCUSSION SYSTEM ===== */
        .discussion-card {
            background: white;
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--space-6);
        }
        
        .discussion-input {
            width: 100%;
            min-height: 120px;
            padding: var(--space-4);
            font-family: var(--font-sans);
            font-size: 1rem;
            border: 2px solid var(--primary-300);
            border-radius: var(--radius-lg);
            resize: vertical;
            transition: all var(--transition-fast);
        }
        
        .discussion-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(45, 156, 219, 0.1);
        }
        
        .discussion-item {
            padding: var(--space-6);
            border-bottom: 1px solid var(--primary-100);
        }
        
        .discussion-item:last-child {
            border-bottom: none;
        }
        
        .discussion-header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-3);
        }
        
        .discussion-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1rem;
            flex-shrink: 0;
        }
        
        .discussion-info {
            flex: 1;
        }
        
        .discussion-author {
            font-weight: 600;
            color: var(--primary-900);
        }
        
        .discussion-time {
            font-size: 0.75rem;
            color: var(--primary-400);
        }
        
        .discussion-content {
            color: var(--primary-700);
            line-height: 1.6;
            margin: var(--space-3) 0;
        }
        
        .discussion-actions {
            display: flex;
            gap: var(--space-4);
        }
        
        .action-btn {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            background: none;
            border: none;
            color: var(--primary-500);
            font-size: 0.875rem;
            cursor: pointer;
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-sm);
            transition: all var(--transition-fast);
        }
        
        .action-btn:hover {
            background: var(--primary-100);
            color: var(--primary-700);
        }
        
        .action-btn.active {
            color: var(--accent-blue);
            font-weight: 600;
        }
        
        /* ===== TEAM MEMBERS ===== */
        .team-card {
            background: white;
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            box-shadow: var(--shadow-md);
        }
        
        .team-member {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3);
            border-radius: var(--radius-lg);
            transition: background var(--transition-fast);
        }
        
        .team-member:hover {
            background: var(--primary-50);
        }
        
        .member-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1rem;
            flex-shrink: 0;
        }
        
        .member-info {
            flex: 1;
        }
        
        .member-name {
            font-weight: 600;
            color: var(--primary-900);
        }
        
        .member-role {
            font-size: 0.875rem;
            color: var(--primary-500);
        }
        
        /* ===== PROGRESS TRACKER ===== */
        .progress-tracker {
            background: white;
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            box-shadow: var(--shadow-md);
        }
        
        .progress-step {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-4) 0;
            border-bottom: 1px solid var(--primary-100);
        }
        
        .progress-step:last-child {
            border-bottom: none;
        }
        
        .step-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 1rem;
        }
        
        .step-completed {
            background: var(--success);
            color: white;
        }
        
        .step-current {
            background: var(--accent-blue);
            color: white;
        }
        
        .step-pending {
            background: var(--primary-200);
            color: var(--primary-500);
        }
        
        .step-content {
            flex: 1;
        }
        
        .step-title {
            font-weight: 600;
            color: var(--primary-900);
        }
        
        .step-description {
            font-size: 0.875rem;
            color: var(--primary-500);
            margin-top: var(--space-1);
        }
        
        /* ===== METRICS ===== */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-4);
            margin-top: var(--space-6);
        }
        
        .metric-card {
            background: var(--primary-50);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            text-align: center;
        }
        
        .metric-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary-900);
            line-height: 1;
            margin-bottom: var(--space-1);
        }
        
        .metric-label {
            font-size: 0.75rem;
            color: var(--primary-500);
            font-weight: 500;
        }
        
        /* ===== TOAST SYSTEM ===== */
        .toast-container {
            position: fixed;
            top: var(--space-4);
            right: var(--space-4);
            z-index: 50;
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            max-width: 400px;
            width: calc(100% - var(--space-8));
        }
        
        .toast {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            box-shadow: var(--shadow-lg);
            border-left: 4px solid var(--info);
            display: flex;
            align-items: flex-start;
            gap: var(--space-3);
            animation: slideInRight 200ms ease-out;
        }
        
        .toast-success { border-left-color: var(--success); }
        .toast-error { border-left-color: var(--error); }
        .toast-warning { border-left-color: var(--warning); }
        
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .toast-icon {
            width: 24px;
            height: 24px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 0.875rem;
        }
        
        .toast-success .toast-icon { background: var(--success); color: white; }
        .toast-error .toast-icon { background: var(--error); color: white; }
        .toast-warning .toast-icon { background: var(--warning); color: white; }
        
        .toast-close {
            background: none;
            border: none;
            color: var(--primary-400);
            cursor: pointer;
            padding: var(--space-1);
            font-size: 1.125rem;
            line-height: 1;
        }
        
        /* ===== LOADING STATES ===== */
        .skeleton {
            background: linear-gradient(90deg, var(--primary-200) 25%, var(--primary-100) 50%, var(--primary-200) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: var(--radius-md);
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .skeleton-text {
            height: 1em;
            margin-bottom: var(--space-2);
        }
        
        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            h1 { font-size: 2rem; }
            h2 { font-size: 1.5rem; }
            h3 { font-size: 1.25rem; }
            
            .project-header {
                padding: var(--space-6);
            }
            
            .pulse-value {
                font-size: 2.5rem;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 640px) {
            .header-content {
                flex-direction: column;
                gap: var(--space-4);
            }
            
            .project-actions {
                flex-direction: column;
                width: 100%;
            }
            
            .project-actions .btn {
                width: 100%;
            }
            
            .discussion-actions {
                flex-wrap: wrap;
            }
        }
        
        /* ===== ANIMATIONS ===== */
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 300ms ease-out;
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content flex items-center justify-between">
                <div class="flex items-center gap-6">
                    <a href="/" class="logo">
                        <div class="logo-icon">TL</div>
                        <div>
                            <div style="font-size: 1.25rem; font-weight: 800; color: var(--primary-900);">ThoraxLab</div>
                            <div style="font-size: 0.875rem; color: var(--primary-500);">Project Details</div>
                        </div>
                    </a>
                </div>
                
                <div class="flex items-center gap-4">
                    <button class="btn btn-secondary" onclick="window.location.href='/'">
                        <span>‚Üê</span>
                        <span>Dashboard</span>
                    </button>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Main Content -->
    <main class="container">
        <!-- Project Header -->
        <div class="project-header">
            <div class="flex items-start justify-between gap-6">
                <div style="flex: 1;">
                    <div class="project-stage-badge stage-idea" id="projectStageBadge">
                        <span>üí°</span>
                        <span>Loading...</span>
                    </div>
                    <h1 id="projectTitle">Loading...</h1>
                    
                    <div class="project-meta">
                        <span class="meta-item" id="projectDepartment">
                            <span>üè•</span>
                            <span>Loading...</span>
                        </span>
                        <span class="meta-item" id="projectCreated">
                            <span>üìÖ</span>
                            <span>Loading...</span>
                        </span>
                        <span class="meta-item" id="projectCreator">
                            <span>üë®‚Äç‚öïÔ∏è</span>
                            <span>Loading...</span>
                        </span>
                    </div>
                    
                    <p class="text-lead" id="projectDescription" style="margin: var(--space-6) 0;">
                        Loading description...
                    </p>
                    
                    <div class="flex flex-wrap gap-3 project-actions">
                        <button class="btn btn-primary" onclick="likeProject()">
                            <span>üëç</span>
                            <span>Like Project</span>
                        </button>
                        <button class="btn btn-secondary" onclick="updateStage()">
                            <span>‚ö°</span>
                            <span>Update Stage</span>
                        </button>
                        <button class="btn btn-tertiary" onclick="exportProject()">
                            <span>üìä</span>
                            <span>Export Data</span>
                        </button>
                    </div>
                </div>
                
                <!-- Pulse Display -->
                <div class="pulse-card" style="min-width: 200px;">
                    <div class="pulse-value" id="pulseValue">--</div>
                    <div class="pulse-label">Pulse Score</div>
                    <div class="pulse-bar">
                        <div class="pulse-fill" id="pulseFill" style="width: 0%"></div>
                    </div>
                    <div class="pulse-description" id="pulseDescription">
                        Calculating engagement...
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Grid -->
        <div class="grid md:grid-cols-3 gap-8">
            <!-- Left Column: Discussions & Activity -->
            <div class="md:col-span-2">
                <!-- New Discussion -->
                <div class="discussion-card fade-in">
                    <h3 style="margin-bottom: var(--space-4);">Add Comment</h3>
                    <textarea class="discussion-input" 
                              id="newComment"
                              placeholder="Share your thoughts, ask questions, or provide feedback..."
                              rows="4"></textarea>
                    <div style="display: flex; justify-content: flex-end; margin-top: var(--space-4);">
                        <button class="btn btn-primary" onclick="postComment()" id="postCommentBtn">
                            <span>üí¨</span>
                            <span>Post Comment</span>
                        </button>
                    </div>
                </div>
                
                <!-- Discussions List -->
                <div class="discussion-card fade-in">
                    <div class="flex items-center justify-between" style="margin-bottom: var(--space-6);">
                        <h3>Discussion</h3>
                        <div class="text-small" id="discussionCount">0 comments</div>
                    </div>
                    
                    <div id="discussionsList">
                        <!-- Discussions will be loaded here -->
                        <div class="discussion-item">
                            <div class="skeleton skeleton-text" style="width: 80%;"></div>
                            <div class="skeleton skeleton-text" style="width: 60%; margin-top: var(--space-2);"></div>
                            <div class="skeleton skeleton-text" style="width: 40%; margin-top: var(--space-2);"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Column: Sidebar -->
            <div>
                <!-- Team Members -->
                <div class="team-card fade-in" style="margin-bottom: var(--space-6);">
                    <h3 style="margin-bottom: var(--space-4);">Project Team</h3>
                    <div id="teamMembers">
                        <!-- Team members will be loaded here -->
                        <div class="team-member">
                            <div class="skeleton" style="width: 48px; height: 48px; border-radius: 50%;"></div>
                            <div style="flex: 1;">
                                <div class="skeleton skeleton-text" style="width: 70%;"></div>
                                <div class="skeleton skeleton-text" style="width: 50%; margin-top: var(--space-1);"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Progress Tracker -->
                <div class="progress-tracker fade-in" style="margin-bottom: var(--space-6);">
                    <h3 style="margin-bottom: var(--space-4);">Project Progress</h3>
                    <div id="progressTracker">
                        <!-- Progress steps will be loaded here -->
                        <div class="progress-step">
                            <div class="skeleton" style="width: 36px; height: 36px; border-radius: 50%;"></div>
                            <div style="flex: 1;">
                                <div class="skeleton skeleton-text" style="width: 60%;"></div>
                                <div class="skeleton skeleton-text" style="width: 40%; margin-top: var(--space-1);"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Metrics -->
                <div class="team-card fade-in">
                    <h3 style="margin-bottom: var(--space-4);">Engagement Metrics</h3>
                    <div class="metrics-grid" id="metricsGrid">
                        <!-- Metrics will be loaded here -->
                        <div class="metric-card">
                            <div class="skeleton skeleton-text" style="width: 50%; margin: 0 auto;"></div>
                            <div class="skeleton skeleton-text" style="width: 30%; margin: var(--space-1) auto 0;"></div>
                        </div>
                        <div class="metric-card">
                            <div class="skeleton skeleton-text" style="width: 50%; margin: 0 auto;"></div>
                            <div class="skeleton skeleton-text" style="width: 30%; margin: var(--space-1) auto 0;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Stage Update Modal -->
    <div class="modal-overlay" id="stageModal" style="display: none;">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3>Update Project Stage</h3>
            </div>
            <div class="modal-body">
                <div class="flex flex-col gap-3">
                    <button class="btn btn-secondary" onclick="setStage('idea')">
                        <span>üí°</span>
                        <span>Ideation</span>
                    </button>
                    <button class="btn btn-secondary" onclick="setStage('planning')">
                        <span>üìã</span>
                        <span>Planning</span>
                    </button>
                    <button class="btn btn-secondary" onclick="setStage('active')">
                        <span>‚ö°</span>
                        <span>Active</span>
                    </button>
                    <button class="btn btn-secondary" onclick="setStage('review')">
                        <span>üîç</span>
                        <span>Review</span>
                    </button>
                    <button class="btn btn-secondary" onclick="setStage('completed')">
                        <span>‚úÖ</span>
                        <span>Completed</span>
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-tertiary" onclick="closeStageModal()" style="width: 100%;">
                    Cancel
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // ===== CONFIGURATION =====
        const API_BASE = window.location.origin;
        let ws = null;
        let currentProject = null;
        let pulseAnimation = null;
        
        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', async () => {
            // Get project ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('id');
            
            if (!projectId) {
                window.location.href = '/';
                return;
            }
            
            // Initialize WebSocket
            initWebSocket(projectId);
            
            // Load project data
            await loadProject(projectId);
            
            // Record view interaction
            await recordInteraction('view');
            
            // Start pulse animation
            startPulseAnimation();
            
            // Setup periodic refresh
            setInterval(() => loadProject(projectId), 30000);
        });
        
        // ===== WEBSOCKET =====
        function initWebSocket(projectId) {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                console.log('‚úÖ WebSocket connected for project');
                // Subscribe to project updates
                ws.send(JSON.stringify({
                    type: 'subscribe_project',
                    projectId: projectId
                }));
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (error) {
                    console.error('WebSocket message error:', error);
                }
            };
            
            ws.onclose = () => {
                console.log('‚ùå WebSocket disconnected');
                setTimeout(() => initWebSocket(projectId), 5000);
            };
        }
        
        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'project_updated':
                    // Refresh project data
                    const projectId = new URLSearchParams(window.location.search).get('id');
                    if (projectId === data.projectId) {
                        loadProject(projectId);
                        showToast('Project updated in real-time', 'info');
                    }
                    break;
            }
        }
        
        // ===== DATA LOADING =====
        async function loadProject(projectId) {
            try {
                const response = await fetch(`${API_BASE}/api/projects/${projectId}`);
                const result = await response.json();
                
                if (result.success) {
                    currentProject = result.data;
                    renderProject();
                    renderDiscussions();
                    renderTeam();
                    renderProgress();
                    renderMetrics();
                } else {
                    throw new Error(result.error || 'Failed to load project');
                }
            } catch (error) {
                console.error('Error loading project:', error);
                showToast('Failed to load project data', 'error');
            }
        }
        
        // ===== RENDERING =====
        function renderProject() {
            if (!currentProject) return;
            
            // Basic info
            document.getElementById('projectTitle').textContent = currentProject.title;
            document.getElementById('projectDescription').textContent = currentProject.description || 'No description provided.';
            document.getElementById('projectDepartment').innerHTML = `<span>üè•</span><span>${currentProject.department}</span>`;
            document.getElementById('projectCreated').innerHTML = `<span>üìÖ</span><span>${formatDate(currentProject.created_at)}</span>`;
            document.getElementById('projectCreator').innerHTML = `<span>üë®‚Äç‚öïÔ∏è</span><span>${currentProject.creator_name || 'Digital Innovation Lead'}</span>`;
            
            // Stage badge
            const stageBadge = document.getElementById('projectStageBadge');
            const stageIcon = getStageIcon(currentProject.stage);
            const stageText = currentProject.stage.charAt(0).toUpperCase() + currentProject.stage.slice(1);
            stageBadge.className = `project-stage-badge stage-${currentProject.stage}`;
            stageBadge.innerHTML = `<span>${stageIcon}</span><span>${stageText}</span>`;
            
            // Pulse score
            const pulseValue = currentProject.pulse_score || 50;
            const pulseElement = document.getElementById('pulseValue');
            const pulseFill = document.getElementById('pulseFill');
            
            // Animate pulse update
            if (pulseElement.textContent !== '--') {
                const currentPulse = parseInt(pulseElement.textContent);
                if (currentPulse !== pulseValue) {
                    animateCounter(pulseElement, currentPulse, pulseValue);
                }
            } else {
                pulseElement.textContent = pulseValue;
            }
            
            pulseFill.style.width = `${pulseValue}%`;
            
            // Pulse description
            const description = getPulseDescription(pulseValue);
            document.getElementById('pulseDescription').textContent = description;
            
            // Update discussion count
            const count = currentProject.discussions?.length || 0;
            document.getElementById('discussionCount').textContent = `${count} comment${count !== 1 ? 's' : ''}`;
        }
        
        function renderDiscussions() {
            const container = document.getElementById('discussionsList');
            const discussions = currentProject.discussions || [];
            
            if (discussions.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: var(--space-8); color: var(--primary-400);">
                        <div style="font-size: 2rem; margin-bottom: var(--space-4);">üí¨</div>
                        <div style="font-weight: 600; color: var(--primary-600); margin-bottom: var(--space-2);">
                            No comments yet
                        </div>
                        <div style="font-size: 0.875rem;">
                            Be the first to share your thoughts
                        </div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = discussions.map(discussion => `
                <div class="discussion-item fade-in">
                    <div class="discussion-header">
                        <div class="discussion-avatar" style="background: ${discussion.avatar_color || '#2D9CDB'};">
                            ${getInitials(discussion.user_name)}
                        </div>
                        <div class="discussion-info">
                            <div class="discussion-author">${escapeHtml(discussion.user_name)}</div>
                            <div class="discussion-time">${formatTimeAgo(discussion.created_at)}</div>
                        </div>
                    </div>
                    <div class="discussion-content">
                        ${escapeHtml(discussion.content)}
                    </div>
                    <div class="discussion-actions">
                        <button class="action-btn" onclick="likeDiscussion(${discussion.id})">
                            <span>üëç</span>
                            <span>Like</span>
                        </button>
                        <button class="action-btn" onclick="replyToDiscussion(${discussion.id})">
                            <span>üí¨</span>
                            <span>Reply</span>
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function renderTeam() {
            const container = document.getElementById('teamMembers');
            const team = currentProject.team || [];
            
            if (team.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: var(--space-4); color: var(--primary-400);">
                        <div style="font-size: 0.875rem;">No team members yet</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = team.map(member => `
                <div class="team-member">
                    <div class="member-avatar" style="background: ${member.avatar_color || '#2D9CDB'};">
                        ${getInitials(member.name)}
                    </div>
                    <div class="member-info">
                        <div class="member-name">${escapeHtml(member.name)}</div>
                        <div class="member-role">${escapeHtml(member.project_role || member.role || 'Contributor')}</div>
                    </div>
                </div>
            `).join('');
        }
        
        function renderProgress() {
            const container = document.getElementById('progressTracker');
            const stages = ['idea', 'planning', 'active', 'review', 'completed'];
            const currentStage = currentProject.stage || 'idea';
            const currentIndex = stages.indexOf(currentStage);
            
            container.innerHTML = stages.map((stage, index) => {
                const isCompleted = index < currentIndex;
                const isCurrent = index === currentIndex;
                const isPending = index > currentIndex;
                
                const icon = getStageIcon(stage);
                const title = stage.charAt(0).toUpperCase() + stage.slice(1);
                const description = getStageDescription(stage);
                
                let stepClass = 'step-pending';
                if (isCompleted) stepClass = 'step-completed';
                if (isCurrent) stepClass = 'step-current';
                
                return `
                    <div class="progress-step">
                        <div class="step-icon ${stepClass}">
                            ${isCompleted ? '‚úì' : icon}
                        </div>
                        <div class="step-content">
                            <div class="step-title">${title}</div>
                            <div class="step-description">${description}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderMetrics() {
            const container = document.getElementById('metricsGrid');
            const stats = currentProject.stats || {};
            
            const metrics = [
                { value: stats.interaction_count || 0, label: 'Total Interactions', icon: 'üìä' },
                { value: stats.like_count || 0, label: 'Likes', icon: 'üëç' },
                { value: stats.comment_count || 0, label: 'Comments', icon: 'üí¨' },
                { value: stats.view_count || 0, label: 'Views', icon: 'üëÅÔ∏è' },
                { value: stats.team_size || 1, label: 'Team Size', icon: 'üë•' },
                { value: stats.discussion_count || 0, label: 'Discussions', icon: 'üí≠' }
            ];
            
            container.innerHTML = metrics.map(metric => `
                <div class="metric-card">
                    <div class="metric-value">${metric.value}</div>
                    <div class="metric-label">${metric.label}</div>
                </div>
            `).join('');
        }
        
        // ===== ACTIONS =====
        async function postComment() {
            const commentInput = document.getElementById('newComment');
            const content = commentInput.value.trim();
            
            if (!content) {
                showToast('Please enter a comment', 'warning');
                return;
            }
            
            const btn = document.getElementById('postCommentBtn');
            const originalText = btn.innerHTML;
            btn.classList.add('btn-loading');
            btn.disabled = true;
            
            try {
                const projectId = new URLSearchParams(window.location.search).get('id');
                
                const response = await fetch(`${API_BASE}/api/discussions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        projectId,
                        content
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Clear input
                    commentInput.value = '';
                    
                    // Add to discussions list immediately
                    if (!currentProject.discussions) currentProject.discussions = [];
                    currentProject.discussions.unshift(result.data);
                    
                    // Update UI
                    renderDiscussions();
                    
                    // Record interaction
                    await recordInteraction('comment');
                    
                    // Show success
                    showToast('Comment posted successfully', 'success');
                } else {
                    throw new Error(result.error || 'Failed to post comment');
                }
            } catch (error) {
                console.error('Error posting comment:', error);
                showToast('Failed to post comment', 'error');
            } finally {
                btn.classList.remove('btn-loading');
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
        
        async function likeProject() {
            try {
                const projectId = new URLSearchParams(window.location.search).get('id');
                
                await recordInteraction('like');
                
                // Optimistic UI update
                const pulseElement = document.getElementById('pulseValue');
                const currentPulse = parseInt(pulseElement.textContent);
                const newPulse = Math.min(currentPulse + 5, 100);
                
                animateCounter(pulseElement, currentPulse, newPulse);
                document.getElementById('pulseFill').style.width = `${newPulse}%`;
                
                // Show success
                showToast('Project liked! Engagement increased.', 'success');
                
                // Update metrics
                if (currentProject.stats) {
                    currentProject.stats.like_count = (currentProject.stats.like_count || 0) + 1;
                    currentProject.stats.interaction_count = (currentProject.stats.interaction_count || 0) + 1;
                    renderMetrics();
                }
            } catch (error) {
                console.error('Error liking project:', error);
                showToast('Failed to like project', 'error');
            }
        }
        
        async function likeDiscussion(discussionId) {
            try {
                const projectId = new URLSearchParams(window.location.search).get('id');
                
                const response = await fetch(`${API_BASE}/api/interactions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        projectId,
                        discussionId,
                        type: 'like',
                        metadata: { discussionId }
                    })
                });
                
                if (response.ok) {
                    showToast('Discussion liked', 'success');
                }
            } catch (error) {
                console.error('Error liking discussion:', error);
            }
        }
        
        async function recordInteraction(type) {
            try {
                const projectId = new URLSearchParams(window.location.search).get('id');
                
                const response = await fetch(`${API_BASE}/api/interactions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        projectId,
                        type,
                        metadata: { source: 'project_page' }
                    })
                });
                
                return response.ok;
            } catch (error) {
                console.error('Error recording interaction:', error);
                return false;
            }
        }
        
        // ===== STAGE MANAGEMENT =====
        function updateStage() {
            document.getElementById('stageModal').style.display = 'flex';
        }
        
        function closeStageModal() {
            document.getElementById('stageModal').style.display = 'none';
        }
        
        async function setStage(newStage) {
            try {
                const projectId = new URLSearchParams(window.location.search).get('id');
                
                // Optimistic update
                currentProject.stage = newStage;
                renderProject();
                renderProgress();
                
                // Record interaction
                await recordInteraction('stage_change');
                
                // Send WebSocket update
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({
                        type: 'interaction',
                        projectId,
                        interactionType: 'stage_change',
                        metadata: { newStage }
                    }));
                }
                
                closeStageModal();
                showToast(`Stage updated to ${newStage}`, 'success');
            } catch (error) {
                console.error('Error updating stage:', error);
                showToast('Failed to update stage', 'error');
            }
        }
        
        // ===== UTILITY FUNCTIONS =====
        function getStageIcon(stage) {
            const icons = {
                'idea': 'üí°',
                'planning': 'üìã',
                'active': '‚ö°',
                'review': 'üîç',
                'completed': '‚úÖ'
            };
            return icons[stage] || 'üìÅ';
        }
        
        function getStageDescription(stage) {
            const descriptions = {
                'idea': 'Initial concept and problem definition',
                'planning': 'Protocol design and resource allocation',
                'active': 'Implementation and data collection',
                'review': 'Analysis and validation',
                'completed': 'Results documented and project closed'
            };
            return descriptions[stage] || '';
        }
        
        function getPulseDescription(score) {
            if (score >= 80) return 'High engagement - Project is very active';
            if (score >= 60) return 'Good engagement - Regular activity';
            if (score >= 40) return 'Moderate engagement - Some activity';
            if (score >= 20) return 'Low engagement - Needs attention';
            return 'Very low engagement - Project may be stalled';
        }
        
        function formatDate(timestamp) {
            if (!timestamp) return 'Unknown';
            const date = new Date(timestamp);
            return date.toLocaleDateString('en-GB', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            });
        }
        
        function formatTimeAgo(timestamp) {
            if (!timestamp) return 'Recently';
            
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            
            return date.toLocaleDateString();
        }
        
        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function animateCounter(element, start, end) {
            const duration = 1000;
            const startTime = performance.now();
            
            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                const currentValue = Math.floor(start + (end - start) * progress);
                element.textContent = currentValue;
                
                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }
            
            requestAnimationFrame(update);
        }
        
        function startPulseAnimation() {
            const pulseElement = document.getElementById('pulseValue');
            
            pulseAnimation = setInterval(() => {
                if (parseInt(pulseElement.textContent) >= 80) {
                    pulseElement.classList.add('pulse-animation');
                    setTimeout(() => {
                        pulseElement.classList.remove('pulse-animation');
                    }, 2000);
                }
            }, 10000);
        }
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toastId = 'toast-' + Date.now();
            
            const icons = {
                success: '‚úÖ',
                error: '‚ö†Ô∏è',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.id = toastId;
            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || icons.info}</div>
                <div class="toast-content">
                    <div class="toast-title">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
            `;
            
            container.appendChild(toast);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                const toastElement = document.getElementById(toastId);
                if (toastElement) {
                    toastElement.remove();
                }
            }, 5000);
        }
        
        function exportProject() {
            if (!currentProject) return;
            
            const data = {
                project: {
                    title: currentProject.title,
                    description: currentProject.description,
                    stage: currentProject.stage,
                    department: currentProject.department,
                    pulse_score: currentProject.pulse_score,
                    created_at: currentProject.created_at,
                    stats: currentProject.stats
                },
                team: currentProject.team || [],
                discussions: currentProject.discussions || [],
                export_date: new Date().toISOString(),
                source: 'ThoraxLab Clinical Innovation Platform'
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `thoraxlab-project-${currentProject.title.toLowerCase().replace(/\s+/g, '-')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Project data exported', 'success');
        }
        
        function replyToDiscussion(discussionId) {
            const commentInput = document.getElementById('newComment');
            commentInput.value = `Replying to discussion ${discussionId}: `;
            commentInput.focus();
            showToast('Ready to reply - mention @username for notifications', 'info');
        }
        
        // Close modals on outside click
        document.getElementById('stageModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                closeStageModal();
            }
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (pulseAnimation) {
                clearInterval(pulseAnimation);
            }
            if (ws) {
                ws.close();
            }
        });
    </script>
</body>
</html>
