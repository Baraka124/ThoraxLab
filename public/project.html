<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Details - ThoraxLab</title>
    <style>
        /* Reuse styles from index.html */
        :root {
            --primary: #1a365d;
            --secondary: #2d9cdb;
            --accent: #27ae60;
            --light-bg: #f8f9fa;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        body {
            background: #f5f7fa;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 30px;
        }
        
        .back-button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .project-header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        .project-title-section {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }
        
        .project-title {
            font-size: 2rem;
            color: var(--primary);
            font-weight: 700;
        }
        
        .project-meta {
            display: flex;
            gap: 15px;
            margin: 15px 0;
        }
        
        .project-meta span {
            background: #e3f2fd;
            color: var(--secondary);
            padding: 6px 15px;
            border-radius: 15px;
            font-size: 0.9rem;
        }
        
        .project-description {
            font-size: 1.1rem;
            line-height: 1.6;
            color: #4a5568;
            margin: 20px 0;
        }
        
        .pulse-display {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
        }
        
        .pulse-number {
            font-size: 3rem;
            font-weight: 700;
            color: var(--accent);
        }
        
        .pulse-label {
            color: #718096;
            font-size: 0.9rem;
        }
        
        .content-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }
        
        .discussion-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .discussion-form {
            margin-bottom: 30px;
        }
        
        .discussion-form textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            min-height: 100px;
            margin-bottom: 15px;
            resize: vertical;
        }
        
        .discussion-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .discussion-item {
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        
        .discussion-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .discussion-user {
            font-weight: 600;
            color: var(--primary);
        }
        
        .discussion-time {
            color: #718096;
            font-size: 0.9rem;
        }
        
        .discussion-content {
            color: #4a5568;
            line-height: 1.5;
        }
        
        .discussion-actions {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }
        
        .action-button {
            background: none;
            border: none;
            color: #718096;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .action-button:hover {
            color: var(--secondary);
        }
        
        .project-sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .sidebar-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .sidebar-card h3 {
            color: var(--primary);
            margin-bottom: 20px;
        }
        
        .member-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .member-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .member-avatar {
            width: 40px;
            height: 40px;
            background: var(--secondary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        
        .member-name {
            font-weight: 500;
            color: var(--primary);
        }
        
        .member-role {
            font-size: 0.85rem;
            color: #718096;
        }
        
        .stage-progress {
            margin: 20px 0;
        }
        
        .stage-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .stage-item.active {
            color: var(--accent);
            font-weight: 600;
        }
        
        .stage-emoji {
            font-size: 1.2rem;
        }
        
        .interaction-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-box {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: #718096;
        }
        
        @media (max-width: 768px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
            
            .project-title-section {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div>
                <div style="font-size: 2rem; font-weight: 800; color: var(--primary);">ThoraxLab</div>
                <div style="color: var(--secondary);">Project Details</div>
            </div>
            <button class="back-button" onclick="goBack()">‚Üê Back to Dashboard</button>
        </header>

        <!-- Project Header -->
        <div class="project-header" id="projectHeader">
            <!-- Loaded dynamically -->
        </div>

        <!-- Main Content -->
        <div class="content-grid">
            <!-- Left: Discussions -->
            <main class="discussion-section">
                <h2>Project Discussions</h2>
                
                <!-- New Discussion Form -->
                <div class="discussion-form">
                    <textarea id="newDiscussion" placeholder="Share your thoughts, ask questions, or provide feedback..."></textarea>
                    <button class="back-button" onclick="postDiscussion()">Post Discussion</button>
                </div>

                <!-- Discussions List -->
                <div class="discussion-list" id="discussionList">
                    <!-- Loaded dynamically -->
                </div>
            </main>

            <!-- Right: Sidebar -->
            <aside class="project-sidebar">
                <!-- Project Members -->
                <div class="sidebar-card">
                    <h3>Project Team</h3>
                    <div class="member-list" id="memberList">
                        <!-- Loaded dynamically -->
                    </div>
                </div>

                <!-- Project Stages -->
                <div class="sidebar-card">
                    <h3>Project Stage</h3>
                    <div class="stage-progress">
                        <div class="stage-item" id="stageIdeation">
                            <span class="stage-emoji">üß†</span>
                            <span>Ideation</span>
                        </div>
                        <div class="stage-item" id="stagePlanning">
                            <span class="stage-emoji">üìã</span>
                            <span>Planning</span>
                        </div>
                        <div class="stage-item" id="stageActive">
                            <span class="stage-emoji">üöÄ</span>
                            <span>Active</span>
                        </div>
                        <div class="stage-item" id="stageReview">
                            <span class="stage-emoji">üîç</span>
                            <span>Review</span>
                        </div>
                        <div class="stage-item" id="stageCompleted">
                            <span class="stage-emoji">‚úÖ</span>
                            <span>Completed</span>
                        </div>
                    </div>
                </div>

                <!-- Interaction Stats -->
                <div class="sidebar-card">
                    <h3>Engagement Metrics</h3>
                    <div class="interaction-stats" id="interactionStats">
                        <!-- Loaded dynamically -->
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <script>
        // Get project ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get('id');
        const API_BASE = window.location.origin + '/api';

        // DOM Elements
        const projectHeader = document.getElementById('projectHeader');
        const discussionList = document.getElementById('discussionList');
        const memberList = document.getElementById('memberList');
        const interactionStats = document.getElementById('interactionStats');

        // Stage mapping
        const stageMapping = {
            'ideation': 'stageIdeation',
            'planning': 'stagePlanning',
            'active': 'stageActive',
            'review': 'stageReview',
            'completed': 'stageCompleted'
        };

        // Fetch project details
        async function fetchProjectDetails() {
            if (!projectId) {
                projectHeader.innerHTML = '<h2>Project not found</h2>';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/projects/${projectId}`);
                if (!response.ok) {
                    throw new Error('Project not found');
                }
                
                const project = await response.json();
                displayProjectHeader(project);
                updateStageProgress(project.stage);
                
                // Fetch discussions
                fetchDiscussions();
                
                // Update members and stats
                updateMembers(project);
                updateStats(project);
                
            } catch (error) {
                console.error('Error fetching project:', error);
                loadSampleProject();
            }
        }

        // Display project header
        function displayProjectHeader(project) {
            const stageEmoji = {
                'ideation': 'üß†',
                'planning': 'üìã',
                'active': 'üöÄ',
                'review': 'üîç',
                'completed': '‚úÖ'
            }[project.stage] || 'üìÅ';

            projectHeader.innerHTML = `
                <div class="project-title-section">
                    <div>
                        <h1 class="project-title">${project.title}</h1>
                        <div class="project-meta">
                            <span>${project.department}</span>
                            <span>${stageEmoji} ${project.stage}</span>
                            <span>Created: ${new Date(project.created_at).toLocaleDateString()}</span>
                        </div>
                    </div>
                    <div class="pulse-display">
                        <div class="pulse-number">${project.pulse_score || 50}</div>
                        <div>
                            <div style="font-weight: 600; color: var(--accent);">Project Pulse</div>
                            <div class="pulse-label">Engagement score</div>
                        </div>
                    </div>
                </div>
                <div class="project-description">
                    ${project.description || 'No description available.'}
                </div>
                <div style="margin-top: 20px;">
                    <button class="back-button" onclick="likeProject()">üëç Like Project</button>
                    <button class="back-button" style="background: var(--accent); margin-left: 10px;" 
                            onclick="updateStage()">
                        Update Stage
                    </button>
                </div>
            `;
        }

        // Fetch discussions
        async function fetchDiscussions() {
            try {
                const response = await fetch(`${API_BASE}/projects/${projectId}/discussions`);
                const discussions = await response.json();
                displayDiscussions(discussions);
            } catch (error) {
                console.error('Error fetching discussions:', error);
                // Load sample discussions
                displaySampleDiscussions();
            }
        }

        // Display discussions
        function displayDiscussions(discussions) {
            discussionList.innerHTML = '';
            
            if (discussions.length === 0) {
                discussionList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #718096;">
                        No discussions yet. Be the first to comment!
                    </div>
                `;
                return;
            }
            
            discussions.forEach(discussion => {
                const discussionItem = document.createElement('div');
                discussionItem.className = 'discussion-item';
                
                discussionItem.innerHTML = `
                    <div class="discussion-header">
                        <div class="discussion-user">${discussion.user_name || 'Clinician'}</div>
                        <div class="discussion-time">${formatTime(discussion.created_at)}</div>
                    </div>
                    <div class="discussion-content">${discussion.content}</div>
                    <div class="discussion-actions">
                        <button class="action-button" onclick="likeDiscussion('${discussion.id}')">üëç Like</button>
                        <button class="action-button" onclick="replyToDiscussion('${discussion.id}')">üí¨ Reply</button>
                    </div>
                `;
                
                discussionList.appendChild(discussionItem);
            });
        }

        // Post new discussion
        async function postDiscussion() {
            const content = document.getElementById('newDiscussion').value.trim();
            if (!content) {
                alert('Please enter discussion content');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/discussions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        project_id: projectId,
                        content: content,
                        type: 'comment'
                    })
                });

                if (response.ok) {
                    document.getElementById('newDiscussion').value = '';
                    fetchDiscussions(); // Refresh discussions
                    alert('Discussion posted successfully!');
                }
            } catch (error) {
                console.error('Error posting discussion:', error);
                alert('Failed to post discussion');
            }
        }

        // Update stage progress visualization
        function updateStageProgress(currentStage) {
            // Reset all stages
            Object.keys(stageMapping).forEach(stage => {
                const element = document.getElementById(stageMapping[stage]);
                if (element) {
                    element.classList.remove('active');
                }
            });

            // Activate current stage and previous ones
            const stageOrder = ['ideation', 'planning', 'active', 'review', 'completed'];
            const currentIndex = stageOrder.indexOf(currentStage);
            
            for (let i = 0; i <= currentIndex; i++) {
                const element = document.getElementById(stageMapping[stageOrder[i]]);
                if (element) {
                    element.classList.add('active');
                }
            }
        }

        // Update members list
        function updateMembers(project) {
            // For now, show sample members
            const members = [
                { name: 'Digital Innovation Lead', role: 'Project Lead', initials: 'DI' },
                { name: 'Dr. Smith', role: 'Clinical Lead', initials: 'DS' },
                { name: 'Nurse Wang', role: 'Clinical Coordinator', initials: 'NW' },
                { name: 'Researcher Kim', role: 'Data Analyst', initials: 'RK' }
            ];

            memberList.innerHTML = '';
            members.forEach(member => {
                const memberItem = document.createElement('div');
                memberItem.className = 'member-item';
                memberItem.innerHTML = `
                    <div class="member-avatar">${member.initials}</div>
                    <div>
                        <div class="member-name">${member.name}</div>
                        <div class="member-role">${member.role}</div>
                    </div>
                `;
                memberList.appendChild(memberItem);
            });
        }

        // Update interaction stats
        function updateStats(project) {
            const stats = [
                { value: project.interaction_count || 0, label: 'Total Interactions' },
                { value: project.comment_count || 0, label: 'Comments' },
                { value: project.like_count || 0, label: 'Likes' },
                { value: project.view_count || 0, label: 'Views' }
            ];

            interactionStats.innerHTML = '';
            stats.forEach(stat => {
                const statBox = document.createElement('div');
                statBox.className = 'stat-box';
                statBox.innerHTML = `
                    <div class="stat-value">${stat.value}</div>
                    <div class="stat-label">${stat.label}</div>
                `;
                interactionStats.appendChild(statBox);
            });
        }

        // Interaction functions
        async function likeProject() {
            try {
                await fetch(`${API_BASE}/interactions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        project_id: projectId,
                        type: 'like',
                        content: 'Project liked'
                    })
                });
                alert('Thanks for your engagement! Pulse score updated.');
                fetchProjectDetails(); // Refresh project data
            } catch (error) {
                console.error('Error liking project:', error);
            }
        }

        async function likeDiscussion(discussionId) {
            try {
                await fetch(`${API_BASE}/interactions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        project_id: projectId,
                        discussion_id: discussionId,
                        type: 'like',
                        content: 'Discussion liked'
                    })
                });
                alert('Discussion liked!');
                fetchDiscussions(); // Refresh discussions
            } catch (error) {
                console.error('Error liking discussion:', error);
            }
        }

        // Utility functions
        function formatTime(timestamp) {
            if (!timestamp) return 'Recently';
            const date = new Date(timestamp);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function goBack() {
            window.location.href = 'index.html';
        }

        function updateStage() {
            const newStage = prompt('Enter new stage (ideation, planning, active, review, completed):');
            if (newStage && ['ideation', 'planning', 'active', 'review', 'completed'].includes(newStage)) {
                alert(`Stage updated to: ${newStage}`);
                updateStageProgress(newStage);
            } else if (newStage) {
                alert('Invalid stage. Please use: ideation, planning, active, review, completed');
            }
        }

        // Sample data for testing
        function loadSampleProject() {
            const sampleProject = {
                id: projectId,
                title: 'AI-Powered COPD Early Detection',
                department: 'Pneumology',
                stage: 'active',
                description: 'Developing machine learning algorithms to detect COPD patterns from routine chest X-rays 6-12 months earlier than current methods. Collaboration between Radiology and Pneumology departments.',
                pulse_score: 85,
                created_at: new Date().toISOString(),
                interaction_count: 24,
                comment_count: 15,
                like_count: 32,
                view_count: 128
            };
            
            displayProjectHeader(sampleProject);
            updateStageProgress('active');
            updateMembers(sampleProject);
            updateStats(sampleProject);
            displaySampleDiscussions();
        }

        function displaySampleDiscussions() {
            const sampleDiscussions = [
                {
                    id: 'disc_001',
                    user_name: 'Dr. Smith',
                    content: 'Just received ethics approval! We can start patient recruitment next week. Need 2 more clinicians for screening.',
                    created_at: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString() // 2 hours ago
                },
                {
                    id: 'disc_002',
                    user_name: 'Researcher Kim',
                    content: 'Updated the algorithm to reduce false positives in patients under 40. The new model achieves 94% accuracy on our test set. Feedback welcome!',
                    created_at: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString() // 1 day ago
                },
                {
                    id: 'disc_003',
                    user_name: 'Nurse Wang',
                    content: 'Should we consider adding a patient-facing component? Maybe a simple dashboard showing their risk score progression?',
                    created_at: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString() // 3 days ago
                }
            ];
            
            displayDiscussions(sampleDiscussions);
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', fetchProjectDetails);
    </script>
</body>
</html>
